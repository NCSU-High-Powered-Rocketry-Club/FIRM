#include "unity.h"
#include "matrixhelper.h"
#include "kalman_filter_config.h"
#include "unscented_kalman_filter.h"
#include "ukf_functions.h"
#include <string.h>
#include "state_machine.h"
#include <stdlib.h>

#define DIM_X 16
#define NUM_SIGMAS (DIM_X * 2 - 1)
#define DIM_P (DIM_X - 1)
#define DIM_Z 10

UKF ukf;

int init_retval;

void setUp(void) {
  // gov work nose cone initial acceleration and magnetometer readings, t=1280 sec
  float init_acc[3] = {-0.7118086F, 0.685839F, -0.01510684F};
  float init_mag[3] = {0.9486259F, -0.15462103F, 0.27604583F};
  float initial_pressure = 101861.625;
  ukf.measurement_function = ukf_measurement_function;
  ukf.state_transition_function = ukf_state_transition_function;
  init_retval = ukf_init(&ukf, initial_pressure, init_acc, init_mag);
}
void tearDown(void) {}


void test_init() {
  TEST_ASSERT_FALSE(init_retval);
}

void test_Wm_Wc() {
  // hand-calculated value for weight component:
  float exp_weight_component = 0.37037037F;
  // hand-calculated value for first value of Wm:
  float exp_first_wm = -10.11111111F;
  // hand-calculated value for first value of Wc:
  float exp_first_wc = -7.201111111F;

  float exp_wm[NUM_SIGMAS] = {exp_first_wm};
  float exp_wc[NUM_SIGMAS] = {exp_first_wc};
  exp_wm[0] = exp_first_wm;
  exp_wc[0] = exp_first_wc;
  for (int i = 1; i < (NUM_SIGMAS); i++) {
    exp_wm[i] = exp_weight_component;
    exp_wc[i] = exp_weight_component;
  }

  float *wm = ukf_test_get_Wm();
  float *wc = ukf_test_get_Wc();
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_wm, wm, NUM_SIGMAS);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_wc, wc, NUM_SIGMAS);
}

void test_initial_values() {
  float exp_initial_x[DIM_X] = {0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F};
  float exp_initial_p_diag[DIM_P] = {0.00000100F, 0.00000100F, 0.00000100F, 0.00000100F, 0.00000100F, 0.00000100F, 0.01000000F, 0.01000000F, 0.01000000F, 0.00001000F, 0.00001000F, 0.00001000F, 0.10000000F, 0.10000000F, 0.10000000F};
  float exp_initial_q_diag[DIM_P] = {1e-5F, 1e-5F, 1e-5F, 1e-5F, 1e-5F, 1e-5F, 1e-3F, 1e-3F, 1e-3F, 1.0F, 1.0F, 1.0F, 1e-1F, 1e-1F, 1e-1F};
  float exp_initial_r_diag[DIM_Z] = {1.0e2F, 1e-2F, 1e-2F, 1e-2F, 1e-3F, 1e-3F, 1e-3F, 1e-2F, 1e-2F, 1e-2F};

  // initialize expected matrices
  float exp_initial_p[DIM_P][DIM_P];
  float exp_initial_q[DIM_P][DIM_P];
  for (int col = 0; col < DIM_P; col++) {
    for (int row = 0; row < DIM_P; row++) {
      // set value when on the diagonal index
      if (col == row) {
        exp_initial_p[row][col] = exp_initial_p_diag[row];
        exp_initial_q[row][col] = exp_initial_q_diag[row];
        continue;
      }
      // set to 0 if not on diagonal
      exp_initial_p[row][col] = 0;
      exp_initial_q[row][col] = 0;
    }
  }
  float exp_initial_r[DIM_Z][DIM_Z];
  for (int col = 0; col < DIM_Z; col++) {
    for (int row = 0; row < DIM_Z; row++) {
      if (col == row) {
        exp_initial_r[row][col] = exp_initial_r_diag[row];
      } else {
        exp_initial_r[row][col] = 0;
      }
    }
  }

  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_initial_x, ukf.X, DIM_X);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_initial_p, ukf.P, DIM_P * DIM_P);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_initial_q, ukf.Q, DIM_P * DIM_P);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_initial_r, ukf.R, DIM_Z * DIM_Z);
}


void test_initial_quaternion_avab(void) {
    float acc_raw[3] = {0.66354551F,-0.70960469F,0.01006805F};
    float mag_raw[3] = {-0.90131203F,-0.09004472F,-0.42370813F};
    float quat[4];
    float mag_world[3];
    float quat_exp[4] = {0.652742028009966F, 0.25655059546948F, -0.65498123710736F, 0.281263605663803F};
    float mag_world_exp[3] = {-0.22320774F,-0.39001031F,-0.89334778F};
    calculate_initial_orientation(acc_raw, mag_raw, quat, mag_world);
    TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-6, quat_exp, quat, 4);
    TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-6, mag_world_exp, mag_world, 3);
}

void test_initial_quaternion_nc(void) {
    float acc_raw[3] = {-0.714738281250000F, 0.683763789062500F, -0.002533593750000F};
    float mag_raw[3] = {0.949800688591410F, -0.186446599203042F, 0.251229611305882F};
    float quat[4];
    float mag_world[3];
    float quat_exp[4] = {-0.118113970323671F, -0.695245545201947F, -0.133844470601829F, 0.696253100230472F};
    float mag_world_exp[3] = {0.164819239805933F, 0.283198344327452F, -0.944792737038121F};
    calculate_initial_orientation(acc_raw, mag_raw, quat, mag_world);
    TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-6, quat_exp, quat, 4);
    TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-6, mag_world_exp, mag_world, 3);
}

void test_predict_sigma_points(void) {
  
  float sigma_points[NUM_SIGMAS][DIM_X];
  float exp_sigma_points[NUM_SIGMAS][DIM_X] = {
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11620065F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11620065F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.11620069F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.05099811F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.05099811F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.05099811F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.23317726F, -0.66422915F, -0.25018016F, 0.66470891F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.27758989F, -0.71123219F, -0.42543721F, 0.48589692F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.45591962F, -0.66730183F, -0.24969789F, 0.53338224F,
    -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11620065F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11620065F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.88379937F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, -0.05099811F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, -0.05099811F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, -0.05099811F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.45640185F, -0.53597516F, -0.47244024F, 0.53030956F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.41198921F, -0.48897210F, -0.29718319F, 0.70912153F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.23365951F, -0.53290248F, -0.47292250F, 0.66163623F
  };
  int ret = ukf_predict(&ukf, 0.0019165236);
  TEST_ASSERT_FALSE(ret);
  ukf_test_get_sigma_points(sigma_points);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_sigma_points, sigma_points, NUM_SIGMAS * DIM_X);
}

void test_predict_sigmas_f(void) {
  ukf_predict(&ukf, 0.0019165236);
  
  float *sigmas_f = ukf_test_get_sigmas_f();
  float sigmas_f_exp[NUM_SIGMAS * DIM_X] = {
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11620065F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11620065F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.11620069F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.02549906F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.02549906F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.02549906F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.23317726F, -0.66422915F, -0.25018016F, 0.66470891F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.27758989F, -0.71123219F, -0.42543721F, 0.48589692F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.45591962F, -0.66730183F, -0.24969789F, 0.53338224F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11620065F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11620065F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.88379937F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, -0.02549906F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, -0.02549906F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, -0.02549906F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.45640185F, -0.53597516F, -0.47244024F, 0.53030956F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.41198921F, -0.48897210F, -0.29718319F, 0.70912153F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.23365951F, -0.53290248F, -0.47292250F, 0.66163623F
  };
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, sigmas_f_exp, sigmas_f, NUM_SIGMAS * DIM_X);
}

void ukf_test_predict_sigmas_f_coast(void) {
  for (int i = 0; i < DIM_P * DIM_P; i++) {
    ukf.Q[i] = 1.0F;
  }
  ukf.X[0] = 0.0F;
  ukf.X[1] = 0.0F;
  ukf.X[2] = 4.0F;
  ukf.X[3] = 0.0F;
  ukf.X[4] = 1.0F;
  ukf.X[5] = 5.5F;
  ukf.X[6] = 1.0F;
  ukf.X[7] = 2.5F;
  ukf.X[8] = -2.5F;
  ukf.X[9] = 6.4F;
  ukf.X[10] = 0.2F;
  ukf.X[11] = -0.3F;
  ukf.X[12] = 0.4F;
  ukf.X[13] = -0.8F;
  ukf.X[14] = -0.1F;
  ukf.X[15] = 0.5F;
  State coast = COAST;
  ukf.flight_state = &coast;

  ukf_predict(&ukf, 0.1);
  float *sigmas_f = ukf_test_get_sigmas_f();
  float sigmas_f_exp[NUM_SIGMAS * DIM_X] = {
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.62125874F, -0.61859363F, 0.05293839F, 0.47809726F,      
    0.40416753F, 0.50416386F, 4.95416355F, 1.70722151F, 4.17692137F, 2.79812121F, 1.36742163F, 2.86742163F, -2.13257837F, 6.76742172F, 0.56742167F, 0.06742167F, 0.66362399F, -0.59388518F, 0.34463769F, 0.29686436F,       
    0.00008216F, 0.10172532F, 4.55090380F, 0.98142666F, 3.45112658F, 2.07232642F, 1.00082159F, 2.50082159F, -2.49917841F, 6.40082169F, 0.20082158F, -0.29917842F, 0.62143636F, -0.61862630F, 0.05361214F, 0.47774899F,      
    0.00004743F, 0.10004743F, 4.55147028F, 0.98073912F, 3.45043945F, 2.07163906F, 1.00047433F, 2.50047445F, -2.49952555F, 6.40047455F, 0.20047434F, -0.29952565F, 0.62136132F, -0.61861253F, 0.05332739F, 0.47789621F,      
    0.00013416F, 0.10003354F, 4.55003357F, 0.98147035F, 3.45016432F, 2.07136369F, 1.00033545F, 2.50033545F, -2.49966455F, 6.40033531F, 0.20033541F, -0.29966459F, 0.62133127F, -0.61860704F, 0.05321344F, 0.47795510F,      
    0.00000000F, 0.10012990F, 4.55002594F, 0.98005456F, 3.45105362F, 2.07121444F, 1.00025976F, 2.50025988F, -2.49974012F, 6.40025997F, 0.20025980F, -0.29974020F, 0.62131494F, -0.61860400F, 0.05315145F, 0.47798714F,      
    0.00000000F, 0.10000000F, 4.55012703F, 0.98000783F, 3.44970798F, 2.07218027F, 1.00021207F, 2.50021219F, -2.49978781F, 6.40021229F, 0.20021214F, -0.29978788F, 0.62130463F, -0.61860216F, 0.05311235F, 0.47800735F,      
    0.00000000F, 0.10000000F, 4.55000019F, 1.09364343F, 3.44950199F, 2.07070160F, 1.11619043F, 2.50000191F, -2.49999809F, 6.40000200F, 0.20000194F, -0.29999807F, 0.62125915F, -0.61859375F, 0.05293997F, 0.47809643F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.56334352F, 2.07070160F, 1.00000000F, 2.61619043F, -2.49999809F, 6.40000200F, 0.20000194F, -0.29999807F, 0.62125915F, -0.61859375F, 0.05293997F, 0.47809643F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.18454313F, 1.00000000F, 2.50000000F, -2.38380957F, 6.40000200F, 0.20000194F, -0.29999807F, 0.62125915F, -0.61859375F, 0.05293997F, 0.47809643F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40370464F, 0.20006073F, -0.29993927F, 0.62138385F, -0.61848432F, 0.05307789F, 0.47806072F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20370422F, -0.29994026F, 0.62128639F, -0.61868352F, 0.05305560F, 0.47793204F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.29629627F, 0.62118363F, -0.61861581F, 0.05312310F, 0.47814569F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.72258836F, -0.49765769F, 0.14427033F, 0.45759040F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.65275961F, -0.68645376F, 0.07362413F, 0.31187433F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.53183728F, -0.65572071F, 0.20795789F, 0.49389571F,      
    -0.40416753F, -0.30416384F, 4.14583635F, 0.25237858F, 2.72207880F, 1.34327865F, 0.63257831F, 2.13257837F, -2.86742163F, 6.03257847F, -0.16742168F, -0.66742170F, 0.50762171F, -0.56496280F, -0.24556985F, 0.60235596F,  
    -0.00008216F, 0.09827468F, 4.54909611F, 0.97817343F, 3.44787359F, 2.06907344F, 0.99917841F, 2.49917841F, -2.50082159F, 6.39917850F, 0.19917843F, -0.30082157F, 0.62108076F, -0.61856061F, 0.05226460F, 0.47844520F,     
    -0.00004743F, 0.09995257F, 4.54852962F, 0.97886097F, 3.44856119F, 2.06976056F, 0.99952567F, 2.49952555F, -2.50047445F, 6.39952564F, 0.19952565F, -0.30047435F, 0.62115604F, -0.61857462F, 0.05254938F, 0.47829819F,     
    -0.00013416F, 0.09996646F, 4.54996634F, 0.97812974F, 3.44883609F, 2.07003593F, 0.99966460F, 2.49966455F, -2.50033545F, 6.39966440F, 0.19966459F, -0.30033541F, 0.62118608F, -0.61858022F, 0.05266331F, 0.47823936F,     
    0.00000000F, 0.09987010F, 4.54997396F, 0.97954553F, 3.44794655F, 2.07018542F, 0.99974018F, 2.49974012F, -2.50025988F, 6.39974022F, 0.19974019F, -0.30025980F, 0.62120253F, -0.61858326F, 0.05272532F, 0.47820732F,      
    0.00000000F, 0.10000000F, 4.54987288F, 0.97959226F, 3.44929218F, 2.06921911F, 0.99978787F, 2.49978781F, -2.50021219F, 6.39978790F, 0.19978787F, -0.30021214F, 0.62121284F, -0.61858517F, 0.05276442F, 0.47818711F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.86595660F, 3.44949818F, 2.07069778F, 0.88380951F, 2.49999809F, -2.50000191F, 6.39999819F, 0.19999807F, -0.30000195F, 0.62125832F, -0.61859357F, 0.05293679F, 0.47809806F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.33565688F, 2.07069778F, 1.00000000F, 2.38380957F, -2.50000191F, 6.39999819F, 0.19999807F, -0.30000195F, 0.62125832F, -0.61859357F, 0.05293679F, 0.47809806F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 1.95685649F, 1.00000000F, 2.50000000F, -2.61619043F, 6.39999819F, 0.19999807F, -0.30000195F, 0.62125832F, -0.61859357F, 0.05293679F, 0.47809806F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.39629507F, 0.19993927F, -0.30006072F, 0.62113363F, -0.61870301F, 0.05279887F, 0.47813377F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.19629577F, -0.30005974F, 0.62123108F, -0.61850375F, 0.05282120F, 0.47826242F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30370376F, 0.62133384F, -0.61857146F, 0.05275369F, 0.47804880F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.49902052F, -0.71871072F, -0.04017520F, 0.48251361F,     
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.56884927F, -0.52991468F, 0.03047098F, 0.62822962F,      
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.68977159F, -0.56064773F, -0.10386276F, 0.44620833F,
  };
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, sigmas_f_exp, sigmas_f, NUM_SIGMAS * DIM_X);
}

void test_predict_residuals(void) {
  ukf_predict(&ukf, 0.019165237);
  float *residuals = ukf_test_get_residuals();
  float residuals_exp[NUM_SIGMAS * DIM_P] = {
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11630081F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11630081F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11630189F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.08044653F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.08044653F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.08044653F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00328493F, 0.00829538F, -0.37082034F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.32453555F, -0.17948970F, -0.00689018F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, -0.17959189F, -0.32450259F, -0.00566831F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11630081F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11630081F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11629975F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, -0.08044653F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, -0.08044653F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, -0.08044653F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00328494F, -0.00829544F, 0.37082034F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, -0.32453555F, 0.17948970F, 0.00689017F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000107F, 0.00000000F, 0.00000000F, 0.00000000F, 0.17959182F, 0.32450268F, 0.00566834F
  };
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, residuals_exp, residuals, NUM_SIGMAS * DIM_P);
}

void test_predict_unscented_transform(void) {
  int ret = ukf_predict(&ukf, 0.019165237);

  float exp_X[DIM_X] = {
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.99999893F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F
  };
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_X, ukf.X, DIM_X);
  float exp_P[DIM_P * DIM_P] = {
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.01001917F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.01001917F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.01001917F, -0.00000000F, -0.00000000F, -0.00000000F, -0.00000000F, -0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00479381F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00479381F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00479381F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.10191652F, -0.00000001F, -0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00000001F, 0.10191651F, -0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00000000F, -0.00000000F, 0.10191651F  };
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_P, ukf.P, DIM_P * DIM_P);
} 

void test_predict_multiple_iterations(void) {
  
  for (int i = 0; i < DIM_P * DIM_P; i++) {
    ukf.Q[i] = 1.0F;
  }
  ukf.X[0] = 0.0F;
  ukf.X[1] = 0.0F;
  ukf.X[2] = 4.0F;
  ukf.X[3] = 0.0F;
  ukf.X[4] = 1.0F;
  ukf.X[5] = 5.5F;
  ukf.X[6] = 1.0F;
  ukf.X[7] = 2.5F;
  ukf.X[8] = -2.5F;
  ukf.X[9] = 6.4F;
  ukf.X[10] = 0.2F;
  ukf.X[11] = -0.3F;
  ukf.X[12] = 0.4F;
  ukf.X[13] = -0.8F;
  ukf.X[14] = -0.1F;
  ukf.X[15] = 0.5F;
  State descent = DESCENT;
  ukf.flight_state = &descent;

  float exp_X[5][DIM_X] = {
    {
      0.00000000F, 0.09999999F, 4.54999971F, 0.97979927F, 3.44950151F, 2.07069826F, 1.00000060F, 2.50000143F, -2.50000262F, 6.40000725F, 0.20000005F, -0.29999989F, 0.61408150F, -0.62650746F, 0.05044753F, 0.47733355F
    },
    {
      0.09798000F, 0.44495052F, 4.75706959F, 1.95960093F, 5.89900875F, -1.35860538F, 1.00000131F, 2.50000191F, -2.50000548F, 6.40000582F, 0.20000006F, -0.30000004F, 0.77361554F, -0.44501132F, 0.16777712F, 0.41873011F
    },
    {
      0.29394004F, 1.03485107F, 4.62120819F, 2.93940425F, 8.34851551F, -4.78791285F, 1.00000131F, 2.50000310F, -2.50000596F, 6.40000057F, 0.20000012F, -0.30000016F, 0.87184310F, -0.25209036F, 0.23876260F, 0.34544557F
    },
    {
      0.58788043F, 1.86970305F, 4.14241791F, 3.91920376F, 10.79801655F, -8.21722317F, 1.00000060F, 2.50000334F, -2.50000763F, 6.39999676F, 0.20000002F, -0.30000016F, 0.92097133F, -0.06120247F, 0.28991455F, 0.25301352F
    },
    {
      0.97980070F, 2.94950604F, 3.32069397F, 4.89900303F, 13.24751091F, -11.64653492F, 1.00000131F, 2.50000501F, -2.50000715F, 6.40000105F, 0.20000026F, -0.30000022F, 0.93373311F, 0.08573917F, 0.31288391F, 0.15131062F
    }
  };

  float exp_P_end[DIM_P * DIM_P] = {
    1.56324840F, 1.55364716F, 1.55364656F, 3.71855760F, 3.67055607F, 3.67055798F, 0.85575813F, 0.84596002F, 0.84596014F, 0.84595990F, 0.84596008F, 0.84595996F, -0.24102265F, 0.34187812F, -0.38825917F,
    1.55364716F, 1.56324852F, 1.55364621F, 3.67055726F, 3.71855712F, 3.67055750F, 0.84596014F, 0.85575801F, 0.84596002F, 0.84595978F, 0.84595996F, 0.84596014F, -0.24104452F, 0.34191009F, -0.38824150F,
    1.55364656F, 1.55364645F, 1.56324720F, 3.67055607F, 3.67055511F, 3.71855712F, 0.84595990F, 0.84595990F, 0.85575783F, 0.84595972F, 0.84596002F, 0.84595996F, -0.24103387F, 0.34190682F, -0.38826108F,
    3.71855760F, 3.67055726F, 3.67055607F, 8.95944786F, 8.71944427F, 8.71944904F, 2.01869011F, 1.96970034F, 1.96970022F, 1.96969926F, 1.96970022F, 1.96970022F, -0.56583244F, 0.65703285F, -0.91302294F,
    3.67055607F, 3.71855712F, 3.67055488F, 8.71944427F, 8.95944309F, 8.71944427F, 1.96969986F, 2.01868963F, 1.96969986F, 1.96969950F, 1.96969986F, 1.96970010F, -0.56591094F, 0.65720552F, -0.91296142F,
    3.67055798F, 3.67055774F, 3.71855712F, 8.71944904F, 8.71944427F, 8.95945263F, 1.96970069F, 1.96970057F, 2.01869106F, 1.96970046F, 1.96970081F, 1.96970057F, -0.56588906F, 0.65717572F, -0.91304708F,
    0.85575813F, 0.84596008F, 0.84595984F, 2.01869011F, 1.96969986F, 1.96970057F, 0.50999999F, 0.50000006F, 0.49999997F, 0.49999991F, 0.50000006F, 0.50000006F, -0.14499646F, 0.25189993F, -0.17836079F,
    0.84595996F, 0.85575795F, 0.84595984F, 1.96970034F, 2.01868963F, 1.96970046F, 0.50000006F, 0.50999993F, 0.50000000F, 0.49999994F, 0.50000000F, 0.50000006F, -0.14501399F, 0.25193101F, -0.17834471F,
    0.84596014F, 0.84595996F, 0.85575783F, 1.96970010F, 1.96969986F, 2.01869106F, 0.50000000F, 0.50000000F, 0.51000011F, 0.49999991F, 0.50000012F, 0.50000006F, -0.14500627F, 0.25192791F, -0.17836764F,
    0.84595990F, 0.84595984F, 0.84595966F, 1.96969926F, 1.96969962F, 1.96970057F, 0.49999994F, 0.49999994F, 0.49999991F, 0.50000989F, 0.49999985F, 0.49999994F, -0.14502779F, 0.25191730F, -0.17837654F,
    0.84596008F, 0.84595990F, 0.84596002F, 1.96970022F, 1.96969998F, 1.96970081F, 0.50000006F, 0.50000006F, 0.50000012F, 0.49999985F, 0.50001001F, 0.50000006F, -0.14501689F, 0.25193131F, -0.17837416F,
    0.84595990F, 0.84596008F, 0.84595990F, 1.96970010F, 1.96970010F, 1.96970057F, 0.50000000F, 0.50000006F, 0.50000006F, 0.49999991F, 0.50000000F, 0.50000989F, -0.14501512F, 0.25193253F, -0.17837268F,
    -0.24102263F, -0.24104452F, -0.24103387F, -0.56583250F, -0.56591100F, -0.56588906F, -0.14499648F, -0.14501400F, -0.14500627F, -0.14502779F, -0.14501689F, -0.14501514F, 2.29079819F, -0.04918709F, -0.82057989F,        
    0.34187812F, 0.34191009F, 0.34190682F, 0.65703285F, 0.65720558F, 0.65717572F, 0.25189993F, 0.25193101F, 0.25192794F, 0.25191730F, 0.25193131F, 0.25193256F, -0.04918716F, 2.29930115F, 0.06001139F,
    -0.38825920F, -0.38824150F, -0.38826111F, -0.91302294F, -0.91296154F, -0.91304719F, -0.17836080F, -0.17834471F, -0.17836767F, -0.17837654F, -0.17837416F, -0.17837270F, -0.82057971F, 0.06001142F, 4.97510958F
  };

  // do 5 predict iterations
  for (int i = 0; i < 5; i++) {
    char message[15];
    strcpy(message, "iteration: ");
    char num[2];
    sprintf(num, "%d", i);
    strcat(message, num);

    int ret = ukf_predict(&ukf, 0.1F);
    TEST_ASSERT_EQUAL_MESSAGE(0, ret, message);
    TEST_ASSERT_FLOAT_ARRAY_WITHIN_MESSAGE(1e-6, exp_X[i], ukf.X, DIM_X, message);
  }
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_P_end, ukf.P, DIM_P * DIM_P);
}