#include "unity.h"
#include "matrixhelper.h"
#include "kalman_filter_config.h"
#include "unscented_kalman_filter.h"
#include "ukf_functions.h"
#include <string.h>
#include "state_machine.h"
#include <stdlib.h>

#define DIM_X 16
#define NUM_SIGMAS (DIM_X * 2 - 1)
#define DIM_P (DIM_X - 1)
#define DIM_Z 10

UKF ukf;

int init_retval;

void setUp(void) {
  // gov work nose cone initial acceleration and magnetometer readings, t=1280 sec
  float init_acc[3] = {-0.7118086F, 0.685839F, -0.01510684F};
  float init_mag[3] = {0.9486259F, -0.15462103F, 0.27604583F};
  float initial_pressure = 101861.625F;
  ukf.measurement_function = ukf_measurement_function;
  ukf.state_transition_function = ukf_state_transition_function;
  init_retval = ukf_init(&ukf, initial_pressure, init_acc, init_mag);
}
void tearDown(void) {}


void test_init() {
  TEST_ASSERT_FALSE(init_retval);
}

void test_Wm_Wc() {
  // hand-calculated value for weight component:
  float exp_weight_component = 0.37037037F;
  // hand-calculated value for first value of Wm:
  float exp_first_wm = -10.11111111F;
  // hand-calculated value for first value of Wc:
  float exp_first_wc = -7.201111111F;

  float exp_wm[NUM_SIGMAS] = {exp_first_wm};
  float exp_wc[NUM_SIGMAS] = {exp_first_wc};
  exp_wm[0] = exp_first_wm;
  exp_wc[0] = exp_first_wc;
  for (int i = 1; i < (NUM_SIGMAS); i++) {
    exp_wm[i] = exp_weight_component;
    exp_wc[i] = exp_weight_component;
  }

  float *wm = ukf_test_get_Wm();
  float *wc = ukf_test_get_Wc();
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_wm, wm, NUM_SIGMAS);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_wc, wc, NUM_SIGMAS);
}

void test_initial_values() {
  float exp_initial_x[DIM_X] = {0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F};
  float exp_initial_p_diag[DIM_P] = {0.00000100F, 0.00000100F, 0.00000100F, 0.00000100F, 0.00000100F, 0.00000100F, 0.01000000F, 0.01000000F, 0.01000000F, 0.00001000F, 0.00001000F, 0.00001000F, 0.10000000F, 0.10000000F, 0.10000000F};
  float exp_initial_q_diag[DIM_P] = {1e-5F, 1e-5F, 1e-5F, 1e-5F, 1e-5F, 1e-5F, 1e-3F, 1e-3F, 1e-3F, 1.0F, 1.0F, 1.0F, 1e-1F, 1e-1F, 1e-1F};
  float exp_initial_r_diag[DIM_Z] = {1.0e2F, 1e-2F, 1e-2F, 1e-2F, 1e-3F, 1e-3F, 1e-3F, 1e-2F, 1e-2F, 1e-2F};

  // initialize expected matrices
  float exp_initial_p[DIM_P][DIM_P];
  float exp_initial_q[DIM_P][DIM_P];
  for (int col = 0; col < DIM_P; col++) {
    for (int row = 0; row < DIM_P; row++) {
      // set value when on the diagonal index
      if (col == row) {
        exp_initial_p[row][col] = exp_initial_p_diag[row];
        exp_initial_q[row][col] = exp_initial_q_diag[row];
        continue;
      }
      // set to 0 if not on diagonal
      exp_initial_p[row][col] = 0;
      exp_initial_q[row][col] = 0;
    }
  }
  float exp_initial_r[DIM_Z][DIM_Z];
  for (int col = 0; col < DIM_Z; col++) {
    for (int row = 0; row < DIM_Z; row++) {
      if (col == row) {
        exp_initial_r[row][col] = exp_initial_r_diag[row];
      } else {
        exp_initial_r[row][col] = 0;
      }
    }
  }

  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_initial_x, ukf.X, DIM_X);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_initial_p, ukf.P, DIM_P * DIM_P);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_initial_q, ukf.Q, DIM_P * DIM_P);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_initial_r, ukf.R, DIM_Z * DIM_Z);
}


void test_initial_quaternion_avab(void) {
    float acc_raw[3] = {0.66354551F,-0.70960469F,0.01006805F};
    float mag_raw[3] = {-0.90131203F,-0.09004472F,-0.42370813F};
    float quat[4];
    float mag_world[3];
    float quat_exp[4] = {0.652742028009966F, 0.25655059546948F, -0.65498123710736F, 0.281263605663803F};
    float mag_world_exp[3] = {-0.22320774F,-0.39001031F,-0.89334778F};
    calculate_initial_orientation(acc_raw, mag_raw, quat, mag_world);
    TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-6, quat_exp, quat, 4);
    TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-6, mag_world_exp, mag_world, 3);
}

void test_initial_quaternion_nc(void) {
    float acc_raw[3] = {-0.714738281250000F, 0.683763789062500F, -0.002533593750000F};
    float mag_raw[3] = {0.949800688591410F, -0.186446599203042F, 0.251229611305882F};
    float quat[4];
    float mag_world[3];
    float quat_exp[4] = {-0.118113970323671F, -0.695245545201947F, -0.133844470601829F, 0.696253100230472F};
    float mag_world_exp[3] = {0.164819239805933F, 0.283198344327452F, -0.944792737038121F};
    calculate_initial_orientation(acc_raw, mag_raw, quat, mag_world);
    TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-6, quat_exp, quat, 4);
    TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-6, mag_world_exp, mag_world, 3);
}

void test_predict_cholesky_descent(void) {
  for (int i = 0; i < DIM_P * DIM_P; i++) {
    ukf.Q[i] = 1.0F;
  }
  ukf.X[0] = 0.0F;
  ukf.X[1] = 0.0F;
  ukf.X[2] = 4.0F;
  ukf.X[3] = 0.0F;
  ukf.X[4] = 1.0F;
  ukf.X[5] = 5.5F;
  ukf.X[6] = 1.0F;
  ukf.X[7] = 2.5F;
  ukf.X[8] = -2.5F;
  ukf.X[9] = 6.4F;
  ukf.X[10] = 0.2F;
  ukf.X[11] = -0.3F;
  ukf.X[12] = 0.4F;
  ukf.X[13] = -0.8F;
  ukf.X[14] = -0.1F;
  ukf.X[15] = 0.5F;
  State descent = DESCENT;
  ukf.flight_state = &descent;
  float exp_chol[DIM_P * DIM_P] = {
    0.36742535F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.36742166F, 0.00164681F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.36742166F, 0.00082340F, 0.00142619F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.36742166F, 0.00082340F, 0.00047539F, 0.00134462F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.36742166F, 0.00082340F, 0.00047539F, 0.00033615F, 0.00130192F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.36742166F, 0.00082340F, 0.00047539F, 0.00033615F, 0.00026038F, 0.00127562F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.36742166F, 0.00082340F, 0.00047539F, 0.00033615F, 0.00026038F, 0.00021260F, 0.11619049F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.36742166F, 0.00082340F, 0.00047539F, 0.00033615F, 0.00026038F, 0.00021260F, 0.00000195F, 0.11619049F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.36742166F, 0.00082340F, 0.00047539F, 0.00033615F, 0.00026038F, 0.00021260F, 0.00000195F, 0.00000195F, 0.11619049F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.36742166F, 0.00082340F, 0.00047539F, 0.00033615F, 0.00026038F, 0.00021260F, 0.00000195F, 0.00000195F, 0.00000195F, 0.00370492F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.36742166F, 0.00082340F, 0.00047539F, 0.00033615F, 0.00026038F, 0.00021260F, 0.00000195F, 0.00000195F, 0.00000195F, 0.00006100F, 0.00370442F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.36742166F, 0.00082340F, 0.00047539F, 0.00033615F, 0.00026038F, 0.00021260F, 0.00000195F, 0.00000195F, 0.00000195F, 0.00006100F, 0.00006000F, 0.00370393F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.36742166F, 0.00082340F, 0.00047539F, 0.00033615F, 0.00026038F, 0.00021260F, 0.00000195F, 0.00000195F, 0.00000195F, 0.00006100F, 0.00006000F, 0.00005904F, 0.36742380F, 0.00000000F, 0.00000000F,
    0.36742166F, 0.00082340F, 0.00047539F, 0.00033615F, 0.00026038F, 0.00021260F, 0.00000195F, 0.00000195F, 0.00000195F, 0.00006100F, 0.00006000F, 0.00005904F, 0.00000059F, 0.36742380F, 0.00000000F,
    0.36742166F, 0.00082340F, 0.00047539F, 0.00033615F, 0.00026038F, 0.00021260F, 0.00000195F, 0.00000195F, 0.00000195F, 0.00006100F, 0.00006000F, 0.00005904F, 0.00000059F, 0.00000059F, 0.36742380F,
};
  
  float *chol = ukf_test_get_cholesky();
  int ret = ukf_predict(&ukf, 0.1);
  TEST_ASSERT_FALSE(ret);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_chol, chol, DIM_P * DIM_P);
}

void test_predict_sigma_points(void) {
  
  float sigma_points[NUM_SIGMAS][DIM_X];
  float exp_sigma_points[NUM_SIGMAS][DIM_X] = {
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11620065F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11620065F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.11620069F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.05099811F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.05099811F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.05099811F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.23317726F, -0.66422915F, -0.25018016F, 0.66470891F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.27758989F, -0.71123219F, -0.42543721F, 0.48589692F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.45591962F, -0.66730183F, -0.24969789F, 0.53338224F,
    -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11620065F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11620065F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.88379937F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, -0.05099811F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, -0.05099811F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, -0.05099811F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.45640185F, -0.53597516F, -0.47244024F, 0.53030956F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.41198921F, -0.48897210F, -0.29718319F, 0.70912153F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.23365951F, -0.53290248F, -0.47292250F, 0.66163623F
  };
  int ret = ukf_predict(&ukf, 0.0019165236);
  TEST_ASSERT_FALSE(ret);
  ukf_test_get_sigma_points(sigma_points);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_sigma_points, sigma_points, NUM_SIGMAS * DIM_X);
}

void test_predict_sigma_points_descent(void) {
  for (int i = 0; i < DIM_P * DIM_P; i++) {
    ukf.Q[i] = 1.0F;
  }
  ukf.X[0] = 0.0F;
  ukf.X[1] = 0.0F;
  ukf.X[2] = 4.0F;
  ukf.X[3] = 0.0F;
  ukf.X[4] = 1.0F;
  ukf.X[5] = 5.5F;
  ukf.X[6] = 1.0F;
  ukf.X[7] = 2.5F;
  ukf.X[8] = -2.5F;
  ukf.X[9] = 6.4F;
  ukf.X[10] = 0.2F;
  ukf.X[11] = -0.3F;
  ukf.X[12] = 0.4F;
  ukf.X[13] = -0.8F;
  ukf.X[14] = -0.1F;
  ukf.X[15] = 0.5F;
  State descent = DESCENT;
  ukf.flight_state = &descent;

  float sigma_points[NUM_SIGMAS][DIM_X];
  float exp_sigma_points[NUM_SIGMAS][DIM_X] = {
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.38851434F, -0.77702868F, -0.09712858F, 0.48564291F,
    0.36742535F, 0.36742166F, 4.36742163F, 0.36742166F, 1.36742163F, 5.86742163F, 1.36742163F, 2.86742163F, -2.13257837F, 6.76742172F, 0.56742167F, 0.06742164F, 0.43918732F, -0.77311075F, 0.20599492F, 0.40863225F,
    0.00000000F, 0.00164681F, 4.00082350F, 0.00082340F, 1.00082338F, 5.50082350F, 1.00082338F, 2.50082350F, -2.49917650F, 6.40082359F, 0.20082341F, -0.29917660F, 0.38867420F, -0.77710843F, -0.09644876F, 0.48552284F,
    0.00000000F, 0.00000000F, 4.00142622F, 0.00047539F, 1.00047541F, 5.50047541F, 1.00047541F, 2.50047541F, -2.49952459F, 6.40047550F, 0.20047539F, -0.29952461F, 0.38860667F, -0.77707481F, -0.09673610F, 0.48557362F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00134462F, 1.00033617F, 5.50033617F, 1.00033617F, 2.50033617F, -2.49966383F, 6.40033627F, 0.20033616F, -0.29966387F, 0.38857964F, -0.77706128F, -0.09685105F, 0.48559391F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00130188F, 5.50026035F, 1.00026035F, 2.50026035F, -2.49973965F, 6.40026045F, 0.20026039F, -0.29973963F, 0.38856491F, -0.77705395F, -0.09691361F, 0.48560497F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50127554F, 1.00021255F, 2.50021267F, -2.49978733F, 6.40021276F, 0.20021261F, -0.29978740F, 0.38855565F, -0.77704930F, -0.09695306F, 0.48561192F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.11619043F, 2.50000191F, -2.49999809F, 6.40000200F, 0.20000196F, -0.29999807F, 0.38851473F, -0.77702886F, -0.09712698F, 0.48564261F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.61619043F, -2.49999809F, 6.40000200F, 0.20000196F, -0.29999807F, 0.38851473F, -0.77702886F, -0.09712698F, 0.48564261F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.38380957F, 6.40000200F, 0.20000196F, -0.29999807F, 0.38851473F, -0.77702886F, -0.09712698F, 0.48564261F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40370512F, 0.20006099F, -0.29993901F, 0.38852620F, -0.77703458F, -0.09707823F, 0.48563403F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20370442F, -0.29994002F, 0.38852599F, -0.77703452F, -0.09707905F, 0.48563418F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.29629609F, 0.38852581F, -0.77703440F, -0.09707984F, 0.48563430F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.52392423F, -0.69297940F, -0.00677643F, 0.49521405F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.39971989F, -0.85267055F, -0.02452001F, 0.33552301F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.29325920F, -0.78169662F, 0.04645366F, 0.54844457F,
    -0.36742535F, -0.36742166F, 3.63257837F, -0.36742166F, 0.63257837F, 5.13257837F, 0.63257837F, 2.13257837F, -2.86742163F, 6.03257847F, -0.16742165F, -0.66742170F, 0.29883543F, -0.70293480F, -0.39050061F, 0.51389617F,
    0.00000000F, -0.00164681F, 3.99917650F, -0.00082340F, 0.99917662F, 5.49917650F, 0.99917662F, 2.49917650F, -2.50082350F, 6.39917660F, 0.19917659F, -0.30082342F, 0.38835430F, -0.77694851F, -0.09780835F, 0.48576275F,
    0.00000000F, 0.00000000F, 3.99857378F, -0.00047539F, 0.99952459F, 5.49952459F, 0.99952459F, 2.49952459F, -2.50047541F, 6.39952469F, 0.19952461F, -0.30047542F, 0.38842195F, -0.77698243F, -0.09752106F, 0.48571214F,
    0.00000000F, 0.00000000F, 4.00000000F, -0.00134462F, 0.99966383F, 5.49966383F, 0.99966383F, 2.49966383F, -2.50033617F, 6.39966393F, 0.19966385F, -0.30033615F, 0.38844901F, -0.77699602F, -0.09740610F, 0.48569188F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 0.99869806F, 5.49973965F, 0.99973959F, 2.49973965F, -2.50026035F, 6.39973974F, 0.19973962F, -0.30026039F, 0.38846374F, -0.77700335F, -0.09734356F, 0.48568085F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.49872446F, 0.99978739F, 2.49978733F, -2.50021267F, 6.39978743F, 0.19978739F, -0.30021262F, 0.38847303F, -0.77700800F, -0.09730411F, 0.48567387F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 0.88380951F, 2.49999809F, -2.50000191F, 6.39999819F, 0.19999805F, -0.30000195F, 0.38851395F, -0.77702850F, -0.09713019F, 0.48564321F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.38380957F, -2.50000191F, 6.39999819F, 0.19999805F, -0.30000195F, 0.38851395F, -0.77702850F, -0.09713019F, 0.48564321F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.61619043F, 6.39999819F, 0.19999805F, -0.30000195F, 0.38851395F, -0.77702850F, -0.09713019F, 0.48564321F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.50000000F, 6.39629507F, 0.19993901F, -0.30006102F, 0.38850248F, -0.77702278F, -0.09717894F, 0.48565179F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.19629559F, -0.30006000F, 0.38850269F, -0.77702284F, -0.09717812F, 0.48565164F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30370393F, 0.38850287F, -0.77702296F, -0.09717733F, 0.48565152F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.24002887F, -0.83492684F, -0.18421185F, 0.45972732F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.36423323F, -0.67523575F, -0.16646826F, 0.61941838F,
    0.00000000F, 0.00000000F, 4.00000000F, 0.00000000F, 1.00000000F, 5.50000000F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.47069395F, -0.74620968F, -0.23744194F, 0.40649679F,
  };
  int ret = ukf_predict(&ukf, 0.1);
  TEST_ASSERT_FALSE(ret);
  ukf_test_get_sigma_points(sigma_points);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_sigma_points, sigma_points, NUM_SIGMAS * DIM_X);
}

void test_predict_sigmas_f(void) {
  ukf_predict(&ukf, 0.0019165236);
  
  float *sigmas_f = ukf_test_get_sigmas_f();
  float sigmas_f_exp[NUM_SIGMAS * DIM_X] = {
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11620065F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11620065F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.11620069F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.02549906F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.02549906F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.02549906F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.23317726F, -0.66422915F, -0.25018016F, 0.66470891F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.27758989F, -0.71123219F, -0.42543721F, 0.48589692F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.45591962F, -0.66730183F, -0.24969789F, 0.53338224F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11620065F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11620065F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.88379937F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, -0.02549906F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, -0.02549906F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, -0.02549906F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.45640185F, -0.53597516F, -0.47244024F, 0.53030956F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.41198921F, -0.48897210F, -0.29718319F, 0.70912153F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.23365951F, -0.53290248F, -0.47292250F, 0.66163623F
  };
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, sigmas_f_exp, sigmas_f, NUM_SIGMAS * DIM_X);
}

void test_predict_sigmas_f_descent(void) {
  for (int i = 0; i < DIM_P * DIM_P; i++) {
    ukf.Q[i] = 1.0F;
  }
  ukf.X[0] = 0.0F;
  ukf.X[1] = 0.0F;
  ukf.X[2] = 4.0F;
  ukf.X[3] = 0.0F;
  ukf.X[4] = 1.0F;
  ukf.X[5] = 5.5F;
  ukf.X[6] = 1.0F;
  ukf.X[7] = 2.5F;
  ukf.X[8] = -2.5F;
  ukf.X[9] = 6.4F;
  ukf.X[10] = 0.2F;
  ukf.X[11] = -0.3F;
  ukf.X[12] = 0.4F;
  ukf.X[13] = -0.8F;
  ukf.X[14] = -0.1F;
  ukf.X[15] = 0.5F;
  State descent = DESCENT;
  ukf.flight_state = &descent;

  int result = ukf_predict(&ukf, 0.1);
  TEST_ASSERT_FALSE(result);
  float *sigmas_f = ukf_test_get_sigmas_f();
  float sigmas_f_exp[NUM_SIGMAS * DIM_X] = {
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.62125874F, -0.61859369F, 0.05293839F, 0.47809723F,
    0.40416753F, 0.50416380F, 4.95416355F, 1.70722139F, 4.17692137F, 2.79812121F, 1.36742163F, 2.86742163F, -2.13257837F, 6.76742172F, 0.56742167F, 0.06742164F, 0.66362399F, -0.59388524F, 0.34463769F, 0.29686436F,
    0.00008234F, 0.10172915F, 4.55090570F, 0.98143011F, 3.45113039F, 2.07233000F, 1.00082338F, 2.50082350F, -2.49917650F, 6.40082359F, 0.20082341F, -0.29917660F, 0.62143677F, -0.61862636F, 0.05361363F, 0.47774822F,
    0.00004754F, 0.10004754F, 4.55147362F, 0.98074120F, 3.45044136F, 2.07164073F, 1.00047541F, 2.50047541F, -2.49952459F, 6.40047550F, 0.20047539F, -0.29952461F, 0.62136155F, -0.61861259F, 0.05332824F, 0.47789577F,
    0.00013446F, 0.10003362F, 4.55003357F, 0.98147404F, 3.45016575F, 2.07136536F, 1.00033617F, 2.50033617F, -2.49966383F, 6.40033627F, 0.20033616F, -0.29966387F, 0.62133145F, -0.61860704F, 0.05321407F, 0.47795478F,
    0.00000000F, 0.10013019F, 4.55002594F, 0.98005515F, 3.45105696F, 2.07121515F, 1.00026035F, 2.50026035F, -2.49973965F, 6.40026045F, 0.20026039F, -0.29973963F, 0.62131506F, -0.61860406F, 0.05315191F, 0.47798690F,
    0.00000000F, 0.10000000F, 4.55012751F, 0.98000830F, 3.44970846F, 2.07218385F, 1.00021255F, 2.50021267F, -2.49978733F, 6.40021276F, 0.20021261F, -0.29978740F, 0.62130475F, -0.61860216F, 0.05311273F, 0.47800714F,
    0.00000000F, 0.10000000F, 4.55000019F, 1.09364343F, 3.44950199F, 2.07070160F, 1.11619043F, 2.50000191F, -2.49999809F, 6.40000200F, 0.20000196F, -0.29999807F, 0.62125915F, -0.61859375F, 0.05293998F, 0.47809640F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.56334352F, 2.07070160F, 1.00000000F, 2.61619043F, -2.49999809F, 6.40000200F, 0.20000196F, -0.29999807F, 0.62125915F, -0.61859375F, 0.05293998F, 0.47809640F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.18454313F, 1.00000000F, 2.50000000F, -2.38380957F, 6.40000200F, 0.20000196F, -0.29999807F, 0.62125915F, -0.61859375F, 0.05293998F, 0.47809640F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40370512F, 0.20006099F, -0.29993901F, 0.62138391F, -0.61848426F, 0.05307811F, 0.47806060F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20370442F, -0.29994002F, 0.62128639F, -0.61868358F, 0.05305580F, 0.47793192F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.29629609F, 0.62118375F, -0.61861581F, 0.05312329F, 0.47814557F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.72258836F, -0.49765772F, 0.14427032F, 0.45759037F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.65275961F, -0.68645376F, 0.07362413F, 0.31187433F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.53183734F, -0.65572071F, 0.20795788F, 0.49389565F,
    -0.40416753F, -0.30416381F, 4.14583635F, 0.25237867F, 2.72207880F, 1.34327865F, 0.63257837F, 2.13257837F, -2.86742163F, 6.03257847F, -0.16742165F, -0.66742170F, 0.50762171F, -0.56496280F, -0.24556985F, 0.60235590F,
    -0.00008234F, 0.09827085F, 4.54909420F, 0.97816998F, 3.44786978F, 2.06906939F, 0.99917662F, 2.49917650F, -2.50082350F, 6.39917660F, 0.19917659F, -0.30082342F, 0.62108040F, -0.61856055F, 0.05226310F, 0.47844598F,
    -0.00004754F, 0.09995246F, 4.54852629F, 0.97885889F, 3.44855905F, 2.06975842F, 0.99952459F, 2.49952459F, -2.50047541F, 6.39952469F, 0.19952461F, -0.30047542F, 0.62115580F, -0.61857462F, 0.05254851F, 0.47829863F,
    -0.00013446F, 0.09996638F, 4.54996634F, 0.97812605F, 3.44883466F, 2.07003427F, 0.99966383F, 2.49966383F, -2.50033617F, 6.39966393F, 0.19966385F, -0.30033615F, 0.62118596F, -0.61858022F, 0.05266271F, 0.47823966F,
    0.00000000F, 0.09986981F, 4.54997396F, 0.97954494F, 3.44794321F, 2.07018447F, 0.99973959F, 2.49973965F, -2.50026035F, 6.39973974F, 0.19973962F, -0.30026039F, 0.62120235F, -0.61858326F, 0.05272485F, 0.47820756F,
    0.00000000F, 0.10000000F, 4.54987240F, 0.97959179F, 3.44929194F, 2.06921625F, 0.99978739F, 2.49978733F, -2.50021267F, 6.39978743F, 0.19978739F, -0.30021262F, 0.62121272F, -0.61858517F, 0.05276403F, 0.47818732F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.86595660F, 3.44949818F, 2.07069778F, 0.88380951F, 2.49999809F, -2.50000191F, 6.39999819F, 0.19999805F, -0.30000195F, 0.62125832F, -0.61859363F, 0.05293678F, 0.47809806F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.33565688F, 2.07069778F, 1.00000000F, 2.38380957F, -2.50000191F, 6.39999819F, 0.19999805F, -0.30000195F, 0.62125832F, -0.61859363F, 0.05293678F, 0.47809806F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 1.95685649F, 1.00000000F, 2.50000000F, -2.61619043F, 6.39999819F, 0.19999805F, -0.30000195F, 0.62125832F, -0.61859363F, 0.05293678F, 0.47809806F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.39629507F, 0.19993901F, -0.30006102F, 0.62113357F, -0.61870301F, 0.05279865F, 0.47813383F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.19629559F, -0.30006000F, 0.62123108F, -0.61850375F, 0.05282098F, 0.47826254F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30370393F, 0.62133378F, -0.61857146F, 0.05275349F, 0.47804889F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.49902055F, -0.71871072F, -0.04017520F, 0.48251361F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.56884927F, -0.52991468F, 0.03047100F, 0.62822962F,
    0.00000000F, 0.10000000F, 4.55000019F, 0.97980005F, 3.44950008F, 2.07069993F, 1.00000000F, 2.50000000F, -2.50000000F, 6.40000010F, 0.20000000F, -0.30000001F, 0.68977159F, -0.56064773F, -0.10386276F, 0.44620830F,
  };
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, sigmas_f_exp, sigmas_f, NUM_SIGMAS * DIM_X);
}

void test_predict_residuals_descent(void) {
  for (int i = 0; i < DIM_P * DIM_P; i++) {
    ukf.Q[i] = 1.0F;
  }
  ukf.X[0] = 0.0F;
  ukf.X[1] = 0.0F;
  ukf.X[2] = 4.0F;
  ukf.X[3] = 0.0F;
  ukf.X[4] = 1.0F;
  ukf.X[5] = 5.5F;
  ukf.X[6] = 1.0F;
  ukf.X[7] = 2.5F;
  ukf.X[8] = -2.5F;
  ukf.X[9] = 6.4F;
  ukf.X[10] = 0.2F;
  ukf.X[11] = -0.3F;
  ukf.X[12] = 0.4F;
  ukf.X[13] = -0.8F;
  ukf.X[14] = -0.1F;
  ukf.X[15] = 0.5F;
  State descent = DESCENT;
  ukf.flight_state = &descent;

  int result = ukf_predict(&ukf, 0.1);
  TEST_ASSERT_FALSE(result);
  float *residuals = ukf_test_get_residuals();
  float residuals_exp[NUM_SIGMAS * DIM_P] = {
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, 0.00000191F, -0.00000048F, -0.00000072F, -0.00000334F, 0.00000811F, 0.00000031F, -0.00000003F, 0.34641507F, 0.30924526F, -0.44188681F,
    0.40416753F, 0.40416384F, 0.40417051F, 0.72742009F, 0.72742510F, 0.72742319F, 0.36742115F, 0.36742091F, 0.36741829F, 0.36742973F, 0.36742198F, 0.36742163F, 0.18822709F, 0.29832497F, -1.12962222F,
    0.00008233F, 0.00172918F, 0.00091267F, 0.00162882F, 0.00163412F, 0.00163198F, 0.00082290F, 0.00082278F, 0.00082016F, 0.00083160F, 0.00082372F, 0.00082338F, 0.34608909F, 0.30924499F, -0.44343391F,
    0.00004753F, 0.00004756F, 0.00148058F, 0.00093991F, 0.00094509F, 0.00094271F, 0.00047493F, 0.00047469F, 0.00047207F, 0.00048351F, 0.00047570F, 0.00047538F, 0.34622687F, 0.30924514F, -0.44278002F,
    0.00013445F, 0.00003364F, 0.00004053F, 0.00167274F, 0.00066948F, 0.00066733F, 0.00033569F, 0.00033545F, 0.00033283F, 0.00034428F, 0.00033647F, 0.00033611F, 0.34628204F, 0.30924520F, -0.44251841F,
    -0.00000001F, 0.00013021F, 0.00003290F, 0.00025386F, 0.00156069F, 0.00051713F, 0.00025988F, 0.00025964F, 0.00025702F, 0.00026846F, 0.00026070F, 0.00026035F, 0.34631199F, 0.30924520F, -0.44237602F,
    -0.00000001F, 0.00000002F, 0.00013447F, 0.00020701F, 0.00021219F, 0.00148582F, 0.00021207F, 0.00021195F, 0.00020933F, 0.00022078F, 0.00021292F, 0.00021258F, 0.34633097F, 0.30924520F, -0.44228628F,
    -0.00000001F, 0.00000002F, 0.00000715F, 0.11384213F, 0.00000572F, 0.00000358F, 0.11618996F, 0.00000119F, -0.00000143F, 0.00001001F, 0.00000226F, 0.00000191F, 0.34641433F, 0.30924526F, -0.44189045F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.11384726F, 0.00000358F, -0.00000048F, 0.11618972F, -0.00000143F, 0.00001001F, 0.00000226F, 0.00000191F, 0.34641433F, 0.30924526F, -0.44189045F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, 0.11384511F, -0.00000048F, -0.00000072F, 0.11618710F, 0.00001001F, 0.00000226F, 0.00000191F, 0.34641433F, 0.30924526F, -0.44189045F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, 0.00000191F, -0.00000048F, -0.00000072F, -0.00000334F, 0.00371313F, 0.00006130F, 0.00006098F, 0.34657669F, 0.30943784F, -0.44224897F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, 0.00000191F, -0.00000048F, -0.00000072F, -0.00000334F, 0.00000811F, 0.00370473F, 0.00005996F, 0.34630573F, 0.30899453F, -0.44224986F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, 0.00000191F, -0.00000048F, -0.00000072F, -0.00000334F, 0.00000811F, 0.00000031F, 0.00370389F, 0.34608755F, 0.30943185F, -0.44207218F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, 0.00000191F, -0.00000048F, -0.00000072F, -0.00000334F, 0.00000811F, 0.00000031F, -0.00000003F, 0.52936232F, 0.50117642F, -0.69626540F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, 0.00000191F, -0.00000048F, -0.00000072F, -0.00000334F, 0.00000811F, 0.00000031F, -0.00000003F, 0.35715351F, 0.00198475F, -0.65450138F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, 0.00000191F, -0.00000048F, -0.00000072F, -0.00000334F, 0.00000811F, 0.00000031F, -0.00000003F, 0.01948135F, 0.40424097F, -0.59616560F,
    -0.40416753F, -0.40416378F, -0.40415668F, -0.72742260F, -0.72741747F, -0.72741938F, -0.36742210F, -0.36742234F, -0.36742496F, -0.36741352F, -0.36742133F, -0.36742172F, 0.47898084F, 0.29990399F, 0.25086051F,
    -0.00008235F, -0.00172913F, -0.00089884F, -0.00163132F, -0.00162649F, -0.00162864F, -0.00082386F, -0.00082421F, -0.00082684F, -0.00081539F, -0.00082310F, -0.00082344F, 0.34674111F, 0.30924553F, -0.44033968F,
    -0.00004755F, -0.00004752F, -0.00146675F, -0.00094241F, -0.00093722F, -0.00093961F, -0.00047588F, -0.00047612F, -0.00047874F, -0.00046730F, -0.00047508F, -0.00047544F, 0.34660327F, 0.30924544F, -0.44099355F,
    -0.00013447F, -0.00003359F, -0.00002670F, -0.00167525F, -0.00066161F, -0.00066376F, -0.00033665F, -0.00033689F, -0.00033951F, -0.00032806F, -0.00033584F, -0.00033617F, 0.34654814F, 0.30924541F, -0.44125518F,
    -0.00000001F, -0.00013017F, -0.00001907F, -0.00025636F, -0.00155306F, -0.00051355F, -0.00026089F, -0.00026107F, -0.00026369F, -0.00025225F, -0.00026007F, -0.00026041F, 0.34651813F, 0.30924538F, -0.44139755F,
    -0.00000001F, 0.00000002F, -0.00012064F, -0.00020951F, -0.00020432F, -0.00148177F, -0.00021309F, -0.00021338F, -0.00021601F, -0.00020456F, -0.00021230F, -0.00021264F, 0.34649926F, 0.30924538F, -0.44148731F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.11384469F, 0.00000191F, -0.00000024F, -0.11619097F, -0.00000262F, -0.00000525F, 0.00000620F, -0.00000164F, -0.00000197F, 0.34641585F, 0.30924526F, -0.44188312F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, -0.11383939F, -0.00000024F, -0.00000048F, -0.11619115F, -0.00000525F, 0.00000620F, -0.00000164F, -0.00000197F, 0.34641585F, 0.30924526F, -0.44188312F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, -0.11384153F, -0.00000048F, -0.00000072F, -0.11619377F, 0.00000620F, -0.00000164F, -0.00000197F, 0.34641585F, 0.30924526F, -0.44188312F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, 0.00000191F, -0.00000048F, -0.00000072F, -0.00000334F, -0.00369692F, -0.00006068F, -0.00006104F, 0.34625363F, 0.30905277F, -0.44152468F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, 0.00000191F, -0.00000048F, -0.00000072F, -0.00000334F, 0.00000811F, -0.00370410F, -0.00006002F, 0.34652448F, 0.30949605F, -0.44152373F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, 0.00000191F, -0.00000048F, -0.00000072F, -0.00000334F, 0.00000811F, 0.00000031F, -0.00370395F, 0.34674281F, 0.30905882F, -0.44170150F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, 0.00000191F, -0.00000048F, -0.00000072F, -0.00000334F, 0.00000811F, 0.00000031F, -0.00000003F, 0.16284996F, 0.11787219F, -0.18753485F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, 0.00000191F, -0.00000048F, -0.00000072F, -0.00000334F, 0.00000811F, 0.00000031F, -0.00000003F, 0.32777536F, 0.60906088F, -0.21943897F,
    -0.00000001F, 0.00000002F, 0.00000715F, -0.00000125F, 0.00000381F, 0.00000191F, -0.00000048F, -0.00000072F, -0.00000334F, 0.00000811F, 0.00000031F, -0.00000003F, 0.66602874F, 0.20699702F, -0.27721044F,
  };
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-6, residuals_exp, residuals, NUM_SIGMAS * DIM_P);
}

void test_predict_unscented_transform(void) {
  int ret = ukf_predict(&ukf, 0.019165237);

  float exp_X[DIM_X] = {
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.99999893F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F
  };
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_X, ukf.X, DIM_X);
  float exp_P[DIM_P * DIM_P] = {
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.01001917F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.01001917F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.01001917F, -0.00000000F, -0.00000000F, -0.00000000F, -0.00000000F, -0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00479381F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00479381F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00479381F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.10191652F, -0.00000001F, -0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00000001F, 0.10191651F, -0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00000000F, -0.00000000F, 0.10191651F  };
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_P, ukf.P, DIM_P * DIM_P);
} 

void test_predict_multiple_iterations(void) {

  for (int i = 0; i < DIM_P * DIM_P; i++) {
    ukf.Q[i] = 1.0F;
  }
  ukf.X[0] = 0.0F;
  ukf.X[1] = 0.0F;
  ukf.X[2] = 4.0F;
  ukf.X[3] = 0.0F;
  ukf.X[4] = 1.0F;
  ukf.X[5] = 5.5F;
  ukf.X[6] = 1.0F;
  ukf.X[7] = 2.5F;
  ukf.X[8] = -2.5F;
  ukf.X[9] = 6.4F;
  ukf.X[10] = 0.2F;
  ukf.X[11] = -0.3F;
  ukf.X[12] = 0.4F;
  ukf.X[13] = -0.8F;
  ukf.X[14] = -0.1F;
  ukf.X[15] = 0.5F;
  State descent = DESCENT;
  ukf.flight_state = &descent;

  float exp_X[3][DIM_X] = {
    {
      -0.00000000F, 0.04999994F, 4.27499151F, 0.48990041F, 2.22475195F, 3.78534698F, 1.00000095F, 2.49999976F, -2.50000000F, 6.39999199F, 0.19999990F, -0.29999992F, 0.50833470F, -0.70923811F, -0.02355482F, 0.48787525F
    },
    {
      0.02449502F, 0.16123755F, 4.46426535F, 0.97980165F, 3.44950771F, 2.07070231F, 1.00000405F, 2.50000000F, -2.50000024F, 6.39999294F, 0.19999997F, -0.29999986F, 0.61379194F, -0.62699282F, 0.04710362F, 0.47741055F
    },
    {
      0.07348517F, 0.33371335F, 4.56779814F, 1.46970165F, 4.67426157F, 0.35605156F, 1.00000679F, 2.50000024F, -2.50000095F, 6.39999199F, 0.19999982F, -0.30000019F, 0.70251185F, -0.53244835F, 0.11229548F, 0.45865646F    },
  };

  float exp_P_end[DIM_P * DIM_P] = {
    0.19325027F, 0.19319522F, 0.19319515F, 0.34169573F, 0.34061560F, 0.34061560F, 0.17063388F, 0.16989897F, 0.16989897F, 0.16989897F, 0.16989902F, 0.16989902F, 0.04734069F, 0.03830888F, -0.06391096F,
    0.19319522F, 0.19325024F, 0.19319510F, 0.34061560F, 0.34169576F, 0.34061554F, 0.16989900F, 0.17063384F, 0.16989896F, 0.16989897F, 0.16989902F, 0.16989902F, 0.04734022F, 0.03830890F, -0.06391035F,
    0.19319515F, 0.19319512F, 0.19325002F, 0.34061530F, 0.34061536F, 0.34169552F, 0.16989891F, 0.16989890F, 0.17063375F, 0.16989890F, 0.16989893F, 0.16989891F, 0.04734927F, 0.03831406F, -0.06390835F,
    0.34169573F, 0.34061560F, 0.34061530F, 0.63354254F, 0.61194140F, 0.61194134F, 0.31166697F, 0.29696989F, 0.29696989F, 0.29696989F, 0.29697001F, 0.29697004F, 0.11289166F, 0.07175282F, -0.08268726F,
    0.34061560F, 0.34169576F, 0.34061536F, 0.61194146F, 0.63354290F, 0.61194140F, 0.29697001F, 0.31166705F, 0.29696992F, 0.29697001F, 0.29697010F, 0.29697004F, 0.11288462F, 0.07175261F, -0.08267720F,
    0.34061560F, 0.34061557F, 0.34169552F, 0.61194140F, 0.61194140F, 0.63354242F, 0.29697007F, 0.29696986F, 0.31166682F, 0.29696995F, 0.29697001F, 0.29697001F, 0.11289320F, 0.07175500F, -0.08268226F,
    0.17063388F, 0.16989900F, 0.16989891F, 0.31166697F, 0.29697004F, 0.29697007F, 0.16000000F, 0.14999996F, 0.14999996F, 0.14999995F, 0.15000002F, 0.15000001F, 0.03503709F, 0.03121710F, -0.06283411F,
    0.16989899F, 0.17063384F, 0.16989890F, 0.29696989F, 0.31166705F, 0.29696986F, 0.14999996F, 0.15999997F, 0.14999992F, 0.14999996F, 0.14999996F, 0.14999999F, 0.03504134F, 0.03121801F, -0.06283813F,
    0.16989897F, 0.16989897F, 0.17063375F, 0.29696989F, 0.29696992F, 0.31166685F, 0.14999998F, 0.14999992F, 0.15999988F, 0.14999993F, 0.14999999F, 0.14999999F, 0.03504192F, 0.03121842F, -0.06283926F,
    0.16989896F, 0.16989897F, 0.16989888F, 0.29696989F, 0.29697001F, 0.29696995F, 0.14999993F, 0.14999996F, 0.14999992F, 0.15000992F, 0.14999993F, 0.14999998F, 0.03505252F, 0.03121922F, -0.06284074F,
    0.16989902F, 0.16989900F, 0.16989893F, 0.29697001F, 0.29697010F, 0.29697001F, 0.15000002F, 0.14999996F, 0.14999999F, 0.14999995F, 0.15000999F, 0.14999996F, 0.03504155F, 0.03121802F, -0.06283855F,
    0.16989902F, 0.16989900F, 0.16989891F, 0.29697004F, 0.29697004F, 0.29697001F, 0.15000001F, 0.14999999F, 0.14999998F, 0.14999998F, 0.14999998F, 0.15000997F, 0.03504094F, 0.03121829F, -0.06283791F,
    0.04734069F, 0.04734022F, 0.04734927F, 0.11289167F, 0.11288463F, 0.11289320F, 0.03503709F, 0.03504134F, 0.03504192F, 0.03505253F, 0.03504155F, 0.03504094F, 0.77741665F, 0.04419205F, -0.29249775F,
    0.03830888F, 0.03830890F, 0.03831406F, 0.07175282F, 0.07175261F, 0.07175499F, 0.03121710F, 0.03121801F, 0.03121842F, 0.03121922F, 0.03121802F, 0.03121829F, 0.04419203F, 0.55318993F, -0.02403733F,
    -0.06391096F, -0.06391035F, -0.06390835F, -0.08268727F, -0.08267722F, -0.08268223F, -0.06283411F, -0.06283813F, -0.06283926F, -0.06284074F, -0.06283855F, -0.06283791F, -0.29249781F, -0.02403736F, 0.63510984F
  };

  // do 5 predict iterations
  for (int i = 0; i < 3; i++) {
    char message[15];
    strcpy(message, "iteration: ");
    char num[2];
    sprintf(num, "%d", i + 1);
    strcat(message, num);

    int ret = ukf_predict(&ukf, 0.05F);
    TEST_ASSERT_EQUAL_MESSAGE(0, ret, message);
    TEST_ASSERT_FLOAT_ARRAY_WITHIN_MESSAGE(1e-6, exp_X[i], ukf.X, DIM_X, message);
  }
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-4, exp_P_end, ukf.P, DIM_P * DIM_P);
}