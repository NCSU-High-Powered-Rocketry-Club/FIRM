#include "unity.h"
#include "matrixhelper.h"
#include "kalman_filter_config.h"
#include "unscented_kalman_filter.h"
#include "ukf_functions.h"
#include <string.h>
#include "state_machine.h"
#include <stdlib.h>

#define DIM_X 16
#define NUM_SIGMAS (DIM_X * 2 - 1)
#define DIM_P (DIM_X - 1)
#define DIM_Z 10

UKF ukf;

int init_retval;

void setUp(void) {
  // gov work nose cone initial acceleration and magnetometer readings, t=1280 sec
  float init_acc[3] = {-0.7118086F, 0.685839F, -0.01510684F};
  float init_mag[3] = {0.9486259F, -0.15462103F, 0.27604583F};
  float initial_pressure = 101861.625;
  ukf.measurement_function = ukf_measurement_function;
  ukf.state_transition_function = ukf_state_transition_function;
  init_retval = ukf_init(&ukf, initial_pressure, init_acc, init_mag);
}
void tearDown(void) {}


void test_init() {
  TEST_ASSERT_FALSE(init_retval);
}

void test_Wm_Wc() {
  // hand-calculated value for weight component:
  float exp_weight_component = 0.37037037F;
  // hand-calculated value for first value of Wm:
  float exp_first_wm = -10.11111111F;
  // hand-calculated value for first value of Wc:
  float exp_first_wc = -7.201111111F;

  float exp_wm[NUM_SIGMAS] = {exp_first_wm};
  float exp_wc[NUM_SIGMAS] = {exp_first_wc};
  exp_wm[0] = exp_first_wm;
  exp_wc[0] = exp_first_wc;
  for (int i = 1; i < (NUM_SIGMAS); i++) {
    exp_wm[i] = exp_weight_component;
    exp_wc[i] = exp_weight_component;
  }

  float *wm = ukf_test_get_Wm();
  float *wc = ukf_test_get_Wc();
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_wm, wm, NUM_SIGMAS);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_wc, wc, NUM_SIGMAS);
}

void test_initial_values() {
  float exp_initial_x[DIM_X] = {0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F};
  float exp_initial_p_diag[DIM_P] = {0.00000100F, 0.00000100F, 0.00000100F, 0.00000100F, 0.00000100F, 0.00000100F, 0.01000000F, 0.01000000F, 0.01000000F, 0.00001000F, 0.00001000F, 0.00001000F, 0.10000000F, 0.10000000F, 0.10000000F};
  float exp_initial_q_diag[DIM_P] = {1e-5F, 1e-5F, 1e-5F, 1e-5F, 1e-5F, 1e-5F, 1e-3F, 1e-3F, 1e-3F, 1.0F, 1.0F, 1.0F, 1e-1F, 1e-1F, 1e-1F};
  float exp_initial_r_diag[DIM_Z] = {1.0e2F, 1e-2F, 1e-2F, 1e-2F, 1e-3F, 1e-3F, 1e-3F, 1e-2F, 1e-2F, 1e-2F};

  // initialize expected matrices
  float exp_initial_p[DIM_P][DIM_P];
  float exp_initial_q[DIM_P][DIM_P];
  for (int col = 0; col < DIM_P; col++) {
    for (int row = 0; row < DIM_P; row++) {
      // set value when on the diagonal index
      if (col == row) {
        exp_initial_p[row][col] = exp_initial_p_diag[row];
        exp_initial_q[row][col] = exp_initial_q_diag[row];
        continue;
      }
      // set to 0 if not on diagonal
      exp_initial_p[row][col] = 0;
      exp_initial_q[row][col] = 0;
    }
  }
  float exp_initial_r[DIM_Z][DIM_Z];
  for (int col = 0; col < DIM_Z; col++) {
    for (int row = 0; row < DIM_Z; row++) {
      if (col == row) {
        exp_initial_r[row][col] = exp_initial_r_diag[row];
      } else {
        exp_initial_r[row][col] = 0;
      }
    }
  }

  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_initial_x, ukf.X, DIM_X);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_initial_p, ukf.P, DIM_P * DIM_P);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_initial_q, ukf.Q, DIM_P * DIM_P);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_initial_r, ukf.R, DIM_Z * DIM_Z);
}


void test_initial_quaternion_avab(void) {
    float acc_raw[3] = {0.66354551F,-0.70960469F,0.01006805F};
    float mag_raw[3] = {-0.90131203F,-0.09004472F,-0.42370813F};
    float quat[4];
    float mag_world[3];
    float quat_exp[4] = {0.652742028009966F, 0.25655059546948F, -0.65498123710736F, 0.281263605663803F};
    float mag_world_exp[3] = {-0.22320774F,-0.39001031F,-0.89334778F};
    calculate_initial_orientation(acc_raw, mag_raw, quat, mag_world);
    TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-6, quat_exp, quat, 4);
    TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-6, mag_world_exp, mag_world, 3);
}

void test_initial_quaternion_nc(void) {
    float acc_raw[3] = {-0.714738281250000F, 0.683763789062500F, -0.002533593750000F};
    float mag_raw[3] = {0.949800688591410F, -0.186446599203042F, 0.251229611305882F};
    float quat[4];
    float mag_world[3];
    float quat_exp[4] = {-0.118113970323671F, -0.695245545201947F, -0.133844470601829F, 0.696253100230472F};
    float mag_world_exp[3] = {0.164819239805933F, 0.283198344327452F, -0.944792737038121F};
    calculate_initial_orientation(acc_raw, mag_raw, quat, mag_world);
    TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-6, quat_exp, quat, 4);
    TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-6, mag_world_exp, mag_world, 3);
}

void test_predict_sigma_points(void) {
  
  float sigma_points[NUM_SIGMAS][DIM_X];
  float exp_sigma_points[NUM_SIGMAS][DIM_X] = {
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00117298F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11620065F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11620065F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.11620069F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.05099811F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.05099811F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.05099811F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.23317726F, -0.66422915F, -0.25018016F, 0.66470891F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.27758989F, -0.71123219F, -0.42543721F, 0.48589692F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.45591962F, -0.66730183F, -0.24969789F, 0.53338224F,
    -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00117298F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11620065F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11620065F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.88379937F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, -0.05099811F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, -0.05099811F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, -0.05099811F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.45640185F, -0.53597516F, -0.47244024F, 0.53030956F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.41198921F, -0.48897210F, -0.29718319F, 0.70912153F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.23365951F, -0.53290248F, -0.47292250F, 0.66163623F
  };
  // test that the predict doesnt fail
  int ret = ukf_predict(&ukf, 0.0019165236);
  TEST_ASSERT_FALSE(ret);
  ukf_test_get_sigma_points(sigma_points);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_sigma_points, sigma_points, NUM_SIGMAS * DIM_X);
}

void test_predict_sigmas_f(void) {
  ukf_predict(&ukf, 0.0019165236);
  
  float *sigmas_f = ukf_test_get_sigmas_f();
  float sigmas_f_exp[NUM_SIGMAS * DIM_X] = {
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11620065F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.11620065F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.11620069F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.02549906F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.02549906F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.02549906F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.23317726F, -0.66422915F, -0.25018016F, 0.66470891F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.27758989F, -0.71123219F, -0.42543721F, 0.48589692F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.45591962F, -0.66730183F, -0.24969789F, 0.53338224F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11620065F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.11620065F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.88379937F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, -0.02549906F, 0.00000000F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, -0.02549906F, 0.00000000F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, -0.02549906F, -0.35070232F, -0.61039323F, -0.36750627F, 0.60775584F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.45640185F, -0.53597516F, -0.47244024F, 0.53030956F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.41198921F, -0.48897210F, -0.29718319F, 0.70912153F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 1.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.23365951F, -0.53290248F, -0.47292250F, 0.66163623F
  };
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, sigmas_f_exp, sigmas_f, NUM_SIGMAS * DIM_X);
}

void test_predict_unscented_transform(void) {
  int ret = ukf_predict(&ukf, 0.0019165236);

  float exp_X[DIM_X] = {
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.99999928F, 0.00000000F, 0.00000000F, 0.00000000F, -0.35070229F, -0.61039323F, -0.36750627F, 0.60775584F
  };
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_X, ukf.X, DIM_X);
  float exp_P[DIM_P * DIM_P] = {
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.01000192F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.01000192F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.01000192F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00048163F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00048163F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00048163F, 0.00000000F, 0.00000000F, 0.00000000F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.10019166F, 0.00000000F, 0.00000001F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.10019165F, -0.00000001F,
    0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, -0.00000000F, 0.00000000F, 0.00000000F, 0.00000000F, 0.00000001F, -0.00000001F, 0.10019164F
  };
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_P, &ukf.P, DIM_P * DIM_P);
}

// void test_predict_multiple_iterations(void) {
//   ukf.state_transition_function = ukf_state_transition_function;
//   TEST_ASSERT_EQUAL(0, ret); // false when no error
//   ukf.X[2] = 4.0;
//   ukf.X[4] = 1.0;
//   ukf.X[6] = 30.0;
//   ukf.X[7] = 2.0;
//   ukf.X[8] = 2.5;
//   ukf.X[9] = 6.4;
//   ukf.X[10] = 0.2;
//   ukf.X[11] = -0.3;
//   ukf.X[12] = -0.6;
//   ukf.X[18] = 4.0;
//   ukf.X[19] = -2.0;
//   ukf.X[20] = -0.1;
//   ukf.X[21] = 0.5;
//   ukf.flight_state = 3;
//   for (int i = 0; i < 21*21; i++) {
//     // initialize Q as all 10's
//     ukf.Q[i] = 1;
//   }

    
//   float exp_X[5][22] = {
//     {
//       1.49186219e-16,  1.00000000e-01,  4.00000000e+00,  2.93940000e+01,
//       2.95960000e+00,  1.46970000e+00,  3.00000000e+01,  2.00000000e+00,
//       2.50000000e+00,  6.40000000e+00,  2.00000000e-01, -3.00000000e-01,
//       -6.0000000e-01, -1.38777878e-16, -3.05311332e-16, -3.19189120e-16,
//       4.16333634e-16, -1.38777878e-17,  9.83341585e-01, -1.53492113e-01,
//       1.82000677e-02,  9.56465122e-02,
//     },
//     {
//       2.93940000e+00,  3.95960000e-01,  4.14697000e+00,  5.87880000e+01,
//       4.91920000e+00,  2.93940000e+00,  3.00000000e+01,  2.00000000e+00,
//       2.50000000e+00,  6.40000000e+00,  2.00000000e-01, -3.00000000e-01,
//       -6.0000000e-01,  8.78926561e-16, -7.39487836e-16,  2.83503379e-16,
//       4.07213945e-15, -2.67643051e-16,  9.85393308e-01,  1.47069363e-01,
//       5.93868548e-02,  6.19986454e-02,
//     },
//     {
//       8.81820000e+00,  8.87880000e-01,  4.44091000e+00,  8.81820000e+01,
//       6.87880000e+00,  4.40910000e+00,  3.00000000e+01,  2.00000000e+00,
//       2.50000000e+00,  6.40000000e+00,  2.00000000e-01, -3.00000000e-01,
//       -6.0000000e-01,  6.87721239e-16, -3.91693580e-16, -7.79421982e-16,
//       5.28441638e-15, -1.28383699e-15,  9.00557437e-01,  4.22561210e-01,
//       1.01673903e-01,  1.00371170e-02,
//     },
//     {
//       1.76364000e+01,  1.57576000e+00,  4.88182000e+00,  1.17576000e+02,
//       8.83840000e+00,  5.87880000e+00,  3.00000000e+01,  2.00000000e+00,
//       2.50000000e+00,  6.40000000e+00,  2.00000000e-01, -3.00000000e-01,
//       -6.0000000e-01, -6.30563217e-16, -9.62493867e-16, -2.53440911e-15,
//       8.51872125e-15,  7.33102428e-17,  7.48288246e-01,  6.43120173e-01,
//       1.55796895e-01, -4.67811082e-02,
//     },
//     {
//       2.93940000e+01,  2.45960000e+00,  5.46970000e+00,  1.46970000e+02,
//       1.07980000e+01,  7.34850000e+00,  3.00000000e+01,  2.00000000e+00,
//       2.50000000e+00,  6.40000000e+00,  2.00000000e-01, -3.00000000e-01,
//       -6.0000000e-01, -7.23224431e-16, -1.75249056e-15,  7.90730775e-17,
//       1.17010618e-14,  1.08603319e-15,  5.59719613e-01,  7.96264914e-01,
//       2.19195174e-01, -6.80412926e-02
//     }
//   };
//   float exp_last_P_row_20[21] = {
//     -0.05412394332415965, -0.05412404892989096, -0.05412404884056456, -0.11499870315392731, -0.11499923101136854, -0.11499923059604471, -0.125681560799304, -0.1256816685605754, -0.12568166847780518, -0.1256798542628146, -0.12568127753133815, -0.12568562947302603, -0.12568166791711718, -0.1256816679137466, -0.1256816679137451, -0.1256816679137455, -0.12568166791375757, -0.1256816679137466, 2.4523451693340026, 1.9694244664119274, 0.13661102927991187
//   };
//   float exp_last_P_row_5[21] = {
//     3.67055683,  3.71855774,  3.67055683,  8.71944422,  8.95944723,  8.71944422,    
//     1.9697    ,  2.01869   ,  1.9697    ,  1.9697    ,  1.9697    ,  1.9697    ,    
//     1.9697    ,  1.9697    ,  1.9697    ,  1.9697    ,  1.9697    ,  1.9697    ,    
//     2.56750218, -0.11499923,  2.60575662,
//   };

//   // do 5 predict iterations
//   for (int i = 0; i < 5; i++) {
//     char message[15];
//     strcpy(message, "iteration: ");
//     char num[2];
//     sprintf(num, "%d", i);
//     strcat(message, num);

//     int ret = ukf_predict(&ukf, 0.1);
//     TEST_ASSERT_EQUAL_MESSAGE(0, ret, message);
//     TEST_ASSERT_FLOAT_ARRAY_WITHIN_MESSAGE(1e-7, exp_X[i], ukf.X, 22, message);
//   }
//   TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_last_P_row_5, &ukf.P[21*4], 21);
//   TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, exp_last_P_row_20, &ukf.P[21*19], 21);
// }