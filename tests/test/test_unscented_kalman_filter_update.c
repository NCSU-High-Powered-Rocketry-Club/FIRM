// NOTE: This test file is mostly commented out (out of date).
// Keep the suite runnable by providing Unity's required hooks.

#include "unity.h"
#include "matrixhelper.h"
#include "kalman_filter_config.h"
#include "unscented_kalman_filter.h"
#include "ukf_functions.h"
#include "state_machine.h"

UKF ukf;

int init_retval;

void setUp(void) {
  // gov work nose cone initial acceleration and magnetometer readings, t=1280 sec
  float init_acc[3] = {-0.7118086F, 0.685839F, -0.01510684F};
  float init_mag[3] = {0.9486259F, -0.15462103F, 0.27604583F};
  float initial_pressure = 101861.625F;
  ukf.measurement_function = ukf_measurement_function;
  ukf.state_transition_function = ukf_state_transition_function;
  init_retval = ukf_init(&ukf, initial_pressure, init_acc, init_mag);
  float test_x[UKF_STATE_DIMENSION] = {-59.13303375F, 16.82012749F, 238.64797974F, -15.86675262F, 3.31964159F, 63.72098541F, 0.23608625F, -0.30229792F, -0.62685311F, 1.47267079F, 0.00057251F, 0.04090103F, 0.80214411F, 0.06948835F, 0.52495402F, -0.27597019F};
  float test_p[UKF_COVARIANCE_DIMENSION * UKF_COVARIANCE_DIMENSION] = {
    18.38045502F, 2.28544760F, 0.34883627F, 6.29760361F, 0.77246898F, 0.14183037F, 0.00005003F, 0.00000583F, 0.00000224F, -0.00000000F, -0.00000000F, -0.00000000F, 0.00001432F, -0.00001399F, 0.00001170F,
    2.28544760F, 9.35810184F, -0.18775398F, 0.77301842F, 3.22553325F, -0.07526305F, 0.00000556F, 0.00004565F, 0.00000143F, -0.00000000F, -0.00000000F, -0.00000000F, 0.00000839F, -0.00000872F, 0.00000687F,
    0.34883627F, -0.18775398F, 0.66666490F, 0.13451841F, -0.07264989F, 0.29704472F, 0.00000171F, 0.00000108F, 0.00004277F, 0.00000000F, 0.00000001F, -0.00000000F, 0.00001157F, -0.00000577F, -0.00000044F,
    6.29760361F, 0.77301842F, 0.13451841F, 2.22914004F, 0.26507533F, 0.05712611F, 0.00935690F, 0.00053433F, 0.00019905F, -0.00000004F, -0.00000001F, -0.00000001F, 0.00135022F, -0.00157568F, 0.00106384F,
    0.77246904F, 3.22553325F, -0.07264989F, 0.26507536F, 1.17354286F, -0.02899574F, 0.00053004F, 0.00896402F, 0.00013201F, -0.00000004F, -0.00000000F, -0.00000001F, 0.00096079F, -0.00106590F, 0.00068562F,
    0.14183037F, -0.07526305F, 0.29704472F, 0.05712611F, -0.02899574F, 0.17498647F, 0.00020867F, 0.00014175F, 0.00868335F, -0.00000000F, -0.00000000F, -0.00000000F, 0.00032873F, -0.00042953F, 0.00032000F,
    0.00005003F, 0.00000556F, 0.00000171F, 0.00935690F, 0.00053004F, 0.00020867F, 0.09750338F, 0.00267366F, 0.00098797F, -0.00000029F, -0.00000010F, -0.00000000F, 0.00805001F, -0.00949262F, 0.00636758F,
    0.00000583F, 0.00004565F, 0.00000108F, 0.00053433F, 0.00896402F, 0.00014175F, 0.00267366F, 0.09549141F, 0.00066210F, -0.00000020F, -0.00000006F, -0.00000001F, 0.00578614F, -0.00641649F, 0.00405293F,
    0.00000224F, 0.00000143F, 0.00004277F, 0.00019905F, 0.00013201F, 0.00868335F, 0.00098797F, 0.00066210F, 0.09409671F, -0.00000007F, -0.00000003F, -0.00000001F, 0.00177258F, -0.00245388F, 0.00186728F,
    -0.00000000F, -0.00000000F, 0.00000000F, -0.00000004F, -0.00000004F, -0.00000000F, -0.00000029F, -0.00000020F, -0.00000007F, 4.51266050F, 0.00000029F, 0.00000000F, 0.00603602F, -0.00753267F, -0.01793060F,
    -0.00000000F, -0.00000000F, 0.00000001F, -0.00000001F, -0.00000000F, -0.00000000F, -0.00000010F, -0.00000006F, -0.00000003F, 0.00000029F, 4.51266146F, 0.00000000F, 0.01036829F, 0.01717215F, -0.00366167F,
    -0.00000000F, -0.00000000F, -0.00000000F, -0.00000001F, -0.00000001F, -0.00000000F, -0.00000000F, -0.00000001F, -0.00000001F, 0.00000000F, -0.00000000F, 4.51266241F, 0.01646655F, -0.00801831F, 0.00887244F,
    0.00001432F, 0.00000839F, 0.00001157F, 0.00135022F, 0.00096079F, 0.00032873F, 0.00805001F, 0.00578614F, 0.00177258F, 0.00603602F, 0.01036829F, 0.01646655F, 0.06713281F, -0.02291187F, 0.01567620F,
    -0.00001399F, -0.00000872F, -0.00000577F, -0.00157568F, -0.00106590F, -0.00042953F, -0.00949262F, -0.00641649F, -0.00245388F, -0.00753267F, 0.01717215F, -0.00801831F, -0.02291187F, 0.07220088F, -0.01751348F,
    0.00001170F, 0.00000687F, -0.00000044F, 0.00106384F, 0.00068562F, 0.00032000F, 0.00636758F, 0.00405293F, 0.00186728F, -0.01793060F, -0.00366167F, 0.00887244F, 0.01567620F, -0.01751348F, 0.05903281F
  };
  float test_z[UKF_MEASUREMENT_DIMENSION] = {98698.09375000F, 0.37742481F, -0.56745690F, 0.15212949F, 52.48521805F, -53.75882339F, 7.82915831F, 0.70090938F, 0.44985437F, 0.55349529F};
  float test_r[UKF_MEASUREMENT_DIMENSION] = {1e3F, 1e-1F, 1e-1F, 1e-1F, 1.0F, 1.0F, 1.0F, 1e-3F, 1e-3F, 1e-3F};
  float test_sigmas_f[UKF_NUM_SIGMAS * UKF_STATE_DIMENSION] = {
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.72105789F, 0.23608579F, -0.30229759F, -0.62685239F, 1.47267270F, 0.00057240F, 0.04090099F, 0.80214113F, 0.06952231F, 0.52494264F, -0.27599174F, 
    -54.15172577F, 17.43949699F, 238.74282837F, -14.16010666F, 3.52899432F, 63.75948334F, 0.23609319F, -0.30229652F, -0.62685198F, 1.47267270F, 0.00057240F, 0.04090099F, 0.80214196F, 0.06952318F, 0.52494210F, -0.27599010F, 
    -59.13306808F, 20.32007027F, 238.55917358F, -15.87061310F, 4.52663612F, 63.68523026F, 0.23608591F, -0.30228841F, -0.62685210F, 1.47267270F, 0.00057240F, 0.04090099F, 0.80214167F, 0.06952288F, 0.52494222F, -0.27599078F, 
    -59.13295746F, 16.82005119F, 239.58805847F, -15.84553719F, 3.30870318F, 64.14024353F, 0.23608640F, -0.30229601F, -0.62682021F, 1.47267270F, 0.00057241F, 0.04090099F, 0.80214232F, 0.06952473F, 0.52494383F, -0.27598545F, 
    -59.13166046F, 16.82018089F, 238.64834595F, -15.55691051F, 3.33725405F, 63.72914124F, 0.25810021F, -0.30048469F, -0.62617779F, 1.47267258F, 0.00057237F, 0.04090094F, 0.80378276F, 0.07105397F, 0.52362502F, -0.27331573F, 
    -59.13305283F, 16.82139587F, 238.64831543F, -15.86672020F, 3.60766006F, 63.72276306F, 0.23667260F, -0.28014392F, -0.62641072F, 1.47267258F, 0.00057240F, 0.04090095F, 0.80321795F, 0.07063381F, 0.52408159F, -0.27420855F, 
    -59.13305283F, 16.82010078F, 238.64938354F, -15.86673832F, 3.31966496F, 63.96072388F, 0.23627004F, -0.30187997F, -0.60133404F, 1.47267270F, 0.00057237F, 0.04090097F, 0.80269033F, 0.06991845F, 0.52450246F, -0.27513060F, 
    -59.13305283F, 16.82010078F, 238.64831543F, -15.85073471F, 3.32008052F, 63.72121811F, 0.59822470F, -0.29247689F, -0.62322408F, 1.47267163F, 0.00057202F, 0.04090097F, 0.81332469F, 0.08005379F, 0.51556069F, -0.25747138F, 
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.33548403F, 63.72116089F, 0.23608579F, 0.05592406F, -0.62451714F, 1.47267199F, 0.00057219F, 0.04090097F, 0.80935454F, 0.07719363F, 0.51897669F, -0.26391208F,  
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.73677063F, 0.23608579F, -0.30229759F, -0.27138069F, 1.47267246F, 0.00057229F, 0.04090096F, 0.80511504F, 0.07144430F, 0.52252215F, -0.27139661F, 
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.72105789F, 0.23608579F, -0.30229759F, -0.62685239F, 3.94088936F, 0.00057256F, 0.04090099F, 0.80174172F, 0.07398811F, 0.52339721F, -0.27891102F, 
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.72105789F, 0.23608579F, -0.30229759F, -0.62685239F, 1.47267270F, 2.46878934F, 0.04090099F, 0.79919505F, 0.07103461F, 0.52941334F, -0.27561370F, 
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.72105789F, 0.23608579F, -0.30229759F, -0.62685239F, 1.47267270F, 0.00057240F, 2.50911808F, 0.80364621F, 0.07245997F, 0.52457219F, -0.27152604F, 
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.72105789F, 0.23608579F, -0.30229759F, -0.62685239F, 1.47267270F, 0.00057240F, 0.04090099F, 0.78828031F, 0.17051086F, 0.48536023F, -0.33758804F, 
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.72105789F, 0.23608579F, -0.30229759F, -0.62685239F, 1.47267270F, 0.00057240F, 0.04090099F, 0.71200460F, 0.08179839F, 0.62943614F, -0.30028081F, 
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.72105789F, 0.23608579F, -0.30229759F, -0.62685239F, 1.47267270F, 0.00057240F, 0.04090099F, 0.83717167F, 0.15953881F, 0.50594246F, -0.13309087F, 
    -64.11437988F, 16.20070457F, 238.55378723F, -17.57338715F, 3.11029840F, 63.68262863F, 0.23607838F, -0.30229867F, -0.62685281F, 1.47267270F, 0.00057240F, 0.04090099F, 0.80214030F, 0.06952144F, 0.52494317F, -0.27599338F, 
    -59.13303375F, 13.32013130F, 238.73744202F, -15.86287880F, 2.11265683F, 63.75688171F, 0.23608567F, -0.30230677F, -0.62685269F, 1.47267270F, 0.00057240F, 0.04090099F, 0.80214059F, 0.06952174F, 0.52494305F, -0.27599269F, 
    -59.13314819F, 16.82015038F, 237.70857239F, -15.88795471F, 3.33058977F, 63.30187225F, 0.23608518F, -0.30229917F, -0.62688458F, 1.47267270F, 0.00057239F, 0.04090099F, 0.80214000F, 0.06951989F, 0.52494144F, -0.27599803F, 
    -59.13444519F, 16.82002258F, 238.64826965F, -16.17658234F, 3.30203867F, 63.71297073F, 0.21407136F, -0.30411050F, -0.62752700F, 1.47267282F, 0.00057243F, 0.04090103F, 0.80048835F, 0.06798968F, 0.52625299F, -0.27866390F, 
    -59.13305283F, 16.81880569F, 238.64830017F, -15.86677170F, 3.03163266F, 63.71935272F, 0.23549898F, -0.32445127F, -0.62729406F, 1.47267282F, 0.00057241F, 0.04090102F, 0.80105931F, 0.06841038F, 0.52580041F, -0.27777317F, 
    -59.13305283F, 16.82010078F, 238.64723206F, -15.86675453F, 3.31962800F, 63.48139191F, 0.23590153F, -0.30271521F, -0.65237075F, 1.47267270F, 0.00057243F, 0.04090101F, 0.80159086F, 0.06912608F, 0.52538216F, -0.27685249F, 
    -59.13305283F, 16.82010078F, 238.64831543F, -15.88275719F, 3.31921220F, 63.72089767F, -0.12605311F, -0.31211829F, -0.63048071F, 1.47267377F, 0.00057278F, 0.04090100F, 0.79042256F, 0.05894446F, 0.53397447F, -0.29432803F,
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.30380869F, 63.72095490F, 0.23608579F, -0.66051924F, -0.62918764F, 1.47267342F, 0.00057261F, 0.04090101F, 0.79469323F, 0.06183067F, 0.53075516F, -0.28799072F, 
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.70534134F, 0.23608579F, -0.30229759F, -0.98232412F, 1.47267294F, 0.00057251F, 0.04090101F, 0.79913557F, 0.06759758F, 0.52734244F, -0.28057596F, 
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.72105789F, 0.23608579F, -0.30229759F, -0.62685239F, -0.99554396F, 0.00057224F, 0.04090099F, 0.80251569F, 0.06505436F, 0.52647185F, -0.27306387F,
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.72105789F, 0.23608579F, -0.30229759F, -0.62685239F, 1.47267270F, -2.46764445F, 0.04090099F, 0.80506229F, 0.06800789F, 0.52045560F, -0.27636144F,
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.72105789F, 0.23608579F, -0.30229759F, -0.62685239F, 1.47267270F, 0.00057240F, -2.42731619F, 0.80061132F, 0.06658266F, 0.52529669F, -0.28044903F,
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.72105789F, 0.23608579F, -0.30229759F, -0.62685239F, 1.47267270F, 0.00057240F, 0.04090099F, 0.80336690F, -0.03256132F, 0.55625635F, -0.21004809F,
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.72105789F, 0.23608579F, -0.30229759F, -0.62685239F, 1.47267270F, 0.00057240F, 0.04090099F, 0.87640798F, 0.05587080F, 0.41006359F, -0.24624242F, 
    -59.13305283F, 16.82010078F, 238.64831543F, -15.86674595F, 3.31964636F, 63.72105789F, 0.23608579F, -0.30229759F, -0.62685239F, 1.47267270F, 0.00057240F, 0.04090099F, 0.74295676F, -0.02258762F, 0.52813584F, -0.41058201F,
  };
  memcpy(ukf.X, test_x, UKF_STATE_DIMENSION * 4);
  memcpy(ukf.P, test_p, UKF_COVARIANCE_DIMENSION * UKF_COVARIANCE_DIMENSION * 4);
  memcpy(ukf.measurement_vector, test_z, UKF_MEASUREMENT_DIMENSION * 4);
  State state = COAST;
  ukf.flight_state = &state;
  for (int i = 0; i < UKF_MEASUREMENT_DIMENSION; i++) {
    for (int j = 0; j < UKF_MEASUREMENT_DIMENSION; j++) {
      if (i == j) {
        ukf.R[i * UKF_MEASUREMENT_DIMENSION + j] = test_r[i];
      } else {
        ukf.R[i * UKF_MEASUREMENT_DIMENSION + j] = 0.0F;
      }
    }
  }
  float *sigmas_f = ukf_test_get_sigmas_f();
  memcpy(sigmas_f, test_sigmas_f, sizeof(test_sigmas_f));
}

void tearDown(void) {}

void test_ukf_verify_sigmas_h(void) {
  float sigmas_h_exp[UKF_NUM_SIGMAS * UKF_MEASUREMENT_DIMENSION] = {
    99012.31250000F, 0.50481391F, -0.53286839F, 0.03575530F, 59.68739700F, -59.64101791F, 2.34345412F, 0.70102364F, 0.44543204F, 0.55691665F,
    99011.18750000F, 0.50481600F, -0.53286821F, 0.03576025F, 59.68739700F, -59.64101791F, 2.34345412F, 0.70102489F, 0.44542924F, 0.55691731F,
    99013.33593750F, 0.50481552F, -0.53286165F, 0.03575127F, 59.68739700F, -59.64101791F, 2.34345412F, 0.70102429F, 0.44543025F, 0.55691725F,
    99001.20312500F, 0.50478351F, -0.53285766F, 0.03577133F, 59.68739700F, -59.64101791F, 2.34345412F, 0.70103109F, 0.44542480F, 0.55691308F,
    99012.31250000F, 0.51395446F, -0.53126889F, 0.05108409F, 59.68739319F, -59.64101410F, 2.34345126F, 0.70265847F, 0.44044390F, 0.55882037F,
    99012.31250000F, 0.50974941F, -0.51608813F, 0.02633433F, 59.68739319F, -59.64101410F, 2.34345174F, 0.70220739F, 0.44197321F, 0.55817962F,
    99012.28125000F, 0.48485643F, -0.52089447F, 0.04626944F, 59.68739700F, -59.64101791F, 2.34345317F, 0.70145875F, 0.44397292F, 0.55753356F,
    99012.31250000F, 0.69428533F, -0.50439030F, 0.30883992F, 59.68733978F, -59.64099121F, 2.34345317F, 0.71130723F, 0.41074467F, 0.57037783F,
    99012.31250000F, 0.61304545F, -0.24496016F, -0.11426067F, 59.68736267F, -59.64099884F, 2.34345317F, 0.70870024F, 0.42162591F, 0.56566387F,        
    99012.31250000F, 0.23522261F, -0.35985914F, 0.18957724F, 59.68738174F, -59.64101028F, 2.34345245F, 0.70308083F, 0.43790817F, 0.56028008F,
    99012.31250000F, 0.50509661F, -0.53258580F, 0.03597342F, 159.68530273F, -159.63891602F, 2.34345412F, 0.70102304F, 0.43920186F, 0.56184381F,       
    99012.31250000F, 0.50452739F, -0.53252798F, 0.04393567F, 159.68533325F, 40.35691071F, 2.34345412F, 0.70716709F, 0.44548571F, 0.54905117F,
    99012.31250000F, 0.49885032F, -0.53845203F, 0.03580567F, 59.68739700F, -59.64101791F, 143.76187134F, 0.70597595F, 0.43759054F, 0.55687743F,       
    99012.31250000F, 0.50880170F, -0.52885187F, 0.03874001F, 59.68739700F, -59.64101791F, 2.34345412F, 0.70182079F, 0.28939596F, 0.65092057F,
    99012.31250000F, 0.52516794F, -0.46086693F, 0.22773786F, 59.68739700F, -59.64101791F, 2.34345412F, 0.78006703F, 0.51299435F, 0.35823500F,
    99012.31250000F, 0.29313454F, -0.67285740F, 0.03740766F, 59.68739700F, -59.64101791F, 2.34345412F, 0.81206799F, 0.17986707F, 0.55515170F,
    99013.40625000F, 0.50481176F, -0.53286862F, 0.03575036F, 59.68739700F, -59.64101791F, 2.34345412F, 0.70102239F, 0.44543481F, 0.55691600F,
    99011.25000000F, 0.50481230F, -0.53287512F, 0.03575933F, 59.68739700F, -59.64101791F, 2.34345412F, 0.70102298F, 0.44543380F, 0.55691606F,
    99023.38281250F, 0.50484425F, -0.53287917F, 0.03573923F, 59.68739700F, -59.64101791F, 2.34345412F, 0.70101619F, 0.44543922F, 0.55692029F,
    99012.31250000F, 0.49578607F, -0.53467751F, 0.02039609F, 59.68740463F, -59.64101791F, 2.34345651F, 0.69934899F, 0.45040831F, 0.55501652F,
    99012.31250000F, 0.50002569F, -0.54968888F, 0.04519602F, 59.68740082F, -59.64102173F, 2.34345579F, 0.69982147F, 0.44888487F, 0.55565488F,
    99012.31250000F, 0.52483833F, -0.54477441F, 0.02528286F, 59.68740082F, -59.64101410F, 2.34345531F, 0.70058483F, 0.44689026F, 0.55630028F,
    99012.31250000F, 0.32830995F, -0.58715415F, -0.24140364F, 59.68745422F, -59.64104462F, 2.34345484F, 0.68883318F, 0.47956267F, 0.54362535F,        
    99012.31250000F, 0.41312176F, -0.82583374F, 0.18769224F, 59.68743515F, -59.64104080F, 2.34345531F, 0.69248587F, 0.46895999F, 0.54821515F,
    99012.31250000F, 0.77932990F, -0.70109487F, -0.11485568F, 59.68741226F, -59.64102554F, 2.34345531F, 0.69886327F, 0.45293462F, 0.55357057F,        
    99012.31250000F, 0.50453287F, -0.53314930F, 0.03553281F, -40.31051636F, 40.35688782F, 2.34345412F, 0.70102435F, 0.45160693F, 0.55192035F,
    99012.31250000F, 0.50503588F, -0.53314435F, 0.02757047F, -40.31052399F, -159.63894653F, 2.34345412F, 0.69479269F, 0.44537848F, 0.56471336F,       
    99012.31250000F, 0.51071501F, -0.52721870F, 0.03570490F, 59.68739700F, -59.64101791F, -139.07498169F, 0.69598424F, 0.45321763F, 0.55695575F,      
    99012.31250000F, 0.50149953F, -0.53625822F, 0.03145792F, 59.68739700F, -59.64101791F, 2.34345412F, 0.69930303F, 0.57320905F, 0.42709100F,
    99012.31250000F, 0.44311771F, -0.56449896F, -0.15827790F, 59.68739700F, -59.64101791F, 2.34345412F, 0.56678641F, 0.38761130F, 0.72698742F,        
    99012.31250000F, 0.65616763F, -0.32916015F, 0.03408676F, 59.68739700F, -59.64101791F, 2.34345412F, 0.50617880F, 0.65730977F, 0.55832511F
  };
  ukf_update(&ukf);
  float *sigmas_h = ukf_test_get_sigmas_h();
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, sigmas_h_exp, sigmas_h, UKF_NUM_SIGMAS * UKF_MEASUREMENT_DIMENSION);
}

void test_ukf_unscented_transform_h(void) {
  float pred_z_exp[UKF_MEASUREMENT_DIMENSION] = {99012.56250000F, 0.48023582F, -0.50376326F, 0.03490354F, 59.68750763F, -59.64105225F, 2.34345746F, 0.64805186F, 0.41832489F, 0.53295839F};
  float S_exp[UKF_MEASUREMENT_DIMENSION * UKF_MEASUREMENT_DIMENSION] = {
    1093.08862305F, -0.01868065F, 0.02246786F, -0.00092475F, 0.00011345F, -0.00003656F, 0.00000379F, -0.04136252F, -0.02105508F, -0.01865490F,
    -0.01868066F, 0.21532378F, 0.01488213F, 0.00105657F, 0.00203133F, -0.03970518F, -0.62143964F, -0.01179801F, 0.03051724F, -0.00194923F,
    0.02246786F, 0.01488213F, 0.21233472F, 0.00235093F, 0.04369594F, 0.00196149F, -0.58837020F, -0.01735247F, 0.02321018F, -0.00538880F,
    -0.00092475F, 0.00105657F, 0.00235093F, 0.21810092F, 0.62241435F, 0.58979130F, 0.00527794F, 0.01721913F, 0.00307682F, -0.02390220F,
    0.00011345F, 0.00203133F, 0.04369582F, 0.62241435F, 14815.19433594F, 0.00317382F, 0.00000000F, 0.45823464F, -0.45547211F, -0.21254985F,
    -0.00003656F, -0.03970512F, 0.00196137F, 0.58979130F, 0.00366210F, 14815.19335938F, -0.00000000F, 0.45835584F, 0.46341020F, -0.94759405F,
    0.00000379F, -0.62143970F, -0.58837020F, 0.00527794F, 0.00000000F, -0.00000000F, 14815.19726562F, 0.52333665F, -0.81850284F, -0.00410237F,
    -0.04136254F, -0.01179801F, -0.01735247F, 0.01721913F, 0.45823464F, 0.45835596F, 0.52333665F, 0.03417301F, -0.01922280F, -0.01177523F,
    -0.02105510F, 0.03051724F, 0.02321018F, 0.00307682F, -0.45547211F, 0.46341020F, -0.81850272F, -0.01922280F, 0.06458016F, -0.01921212F,
    -0.01865490F, -0.00194924F, -0.00538880F, -0.02390220F, -0.21254985F, -0.94759405F, -0.00410237F, -0.01177523F, -0.01921212F, 0.03721136F
  };
  ukf_update(&ukf);
  float *pred_z = ukf_test_get_pred_z();
  float *s = ukf_test_get_S();
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-7, pred_z_exp, pred_z, UKF_MEASUREMENT_DIMENSION);
  TEST_ASSERT_FLOAT_ARRAY_WITHIN(1e-4, S_exp, s, UKF_MEASUREMENT_DIMENSION * UKF_MEASUREMENT_DIMENSION);
}

// void test_ukf_update_x_and_P(void) {
//     int status = ukf_predict(&ukf, dt);
//     TEST_ASSERT_EQUAL(0, status);
//     status = ukf_update(&ukf, measurements);
//     TEST_ASSERT_EQUAL(0, status);

//     double exp_x[22] = {9.719139395931109, -37.184055925274990, 40.822220773710988, 32.779314943842138, -115.329459819460041, 127.723697796805382, 7.169058576391072, -19.254512169669812, 20.547383460044127, 40.171985511035395, 1.325644433769025, 2.615975136063395, 0.000078891093802, -0.000052811331349, 0.000028853845459, 0.000077591281369, 0.000189405552908, 0.000087355771394, -0.790000718805788, -0.052514215012383, 0.447677711598221, 0.415602921123219};
//     double exp_P[21*21] = {
//         0.512955871575637, 0.145011772436901, 0.099879558927374, 1.409393966334771, 0.459174342868087, 0.400850356344424, 0.103195813562573, 0.055510210888437, 0.075783601137835, 0.000002081396127, 0.000000894075515, -0.000000806769194, -0.000120046198634, -0.000045241445053, -0.000322677314011, -0.000000045981461, 0.000000034192320, 0.000000038456085, -0.000141454304177, -0.002368543433779, 0.006519051327127,
//         0.145011772436902, 0.515076956455987, -0.129619696589213, 0.426469918611705, 1.593640444503120, -0.611476465117813, 0.017682881647797, 0.237170608468721, -0.127866143124710, 0.000005359238611, 0.000001687578376, 0.000000931409750, 0.000336952083771, -0.000043005745224, -0.000121880243164, -0.000000033007171, 0.000000023201864, 0.000000040045386, -0.000775985818501, -0.006928792786582, 0.017533313529362,
//         0.099879558927371, -0.129619696589219, 0.484529881241369, 0.374223262031821, -0.621310216453302, 1.584946211766342, 0.096610861531552, -0.173285048726645, 0.226164826309635, -0.000002934523561, -0.000000935074338, -0.000001169252262, -0.000058587206026, 0.000400285860733, -0.000097587873057, -0.000000014266519, 0.000000012073431, 0.000000030720865, 0.000099929407116, 0.003587826402153, -0.010010171243900,
//         1.409393966334776, 0.426469918611709, 0.374223262031831, 4.965194885455262, 1.743024215354996, 1.951117580886373, 0.933735476769089, 0.407710410498601, 0.651405286653048, 0.000016407477694, 0.000008785281676, -0.000011158181567, -0.000215967315260, -0.000031559916775, -0.000483364347422, -0.000000157281565, 0.000000106118441, 0.000000130495373, 0.001822953833604, -0.015266460202258, 0.051636200949963,
//         0.459174342868098, 1.593640444503103, -0.621310216453242, 1.743024215354922, 6.843962562245235, -3.317426201404706, 0.214772578952336, 2.069184667069901, -0.980783246341558, 0.000047516550602, 0.000013870317521, 0.000010349036949, 0.000568829060309, -0.000242431336550, -0.000151921146252, -0.000000125463353, 0.000000077030568, 0.000000127340179, -0.009017527996919, -0.063764093122460, 0.154926605126624,
//         0.400850356344398, -0.611476465117872, 1.584946211766355, 1.951117580886260, -3.317426201405303, 7.115900638623171, 0.835267261622707, -1.259551008180427, 1.858050591139737, -0.000019998347746, -0.000007303871707, -0.000007038451857, -0.000139972384932, 0.000792242228653, -0.000330439860898, -0.000000050503335, 0.000000040290120, 0.000000104612937, -0.001513178549207, 0.022237506926018, -0.069165443813296,
//         0.103195813562587, 0.017682881647837, 0.096610861531533, 0.933735476769172, 0.214772578952704, 0.835267261622600, 0.875190712620842, 0.190964239444869, 0.566785819386788, 0.000010234841925, 0.000008796139729, -0.000015536093840, -0.000007025439940, 0.000025806098460, 0.000014597868320, -0.000000026761033, 0.000000017272035, 0.000000026867073, 0.006844186599852, -0.002899679394907, 0.032680597164969,
//         0.055510210888437, 0.237170608468680, -0.173285048726580, 0.407710410498480, 2.069184667069658, -1.259551008179826, 0.190964239444542, 1.617581737133734, -0.620249135234843, 0.000037899804892, 0.000009261617237, 0.000011971510730, 0.000016707575841, -0.000071719343587, 0.000015966010613, -0.000000028262743, 0.000000016236318, 0.000000019389402, -0.010709623353347, -0.054706812271068, 0.122757381666512,
//         0.075783601137810, -0.127866143124780, 0.226164826309669, 0.651405286652900, -0.980783246342209, 1.858050591139937, 0.566785819386781, -0.620249135235418, 1.251707289213282, -0.000007672390160, -0.000005024619111, 0.000000179564879, -0.000018896196843, 0.000073926510897, -0.000101849322803, -0.000000011312880, 0.000000009450372, 0.000000017168715, -0.005691029695589, 0.003318207462942, -0.028559021483076,
//         0.000002081396127, 0.000005359238612, -0.000002934523563, 0.000016407477697, 0.000047516550606, -0.000019998347762, 0.000010234841934, 0.000037899804889, -0.000007672390177, 0.030441531540248, -0.000000003745949, 0.000000000021500, 0.000000000322249, 0.000000000737239, 0.000000000949599, -0.000001228578887, 0.000001228578863, 0.000000000000691, -0.001223907914016, -0.000241346768348, 0.000078010664049,
//         0.000000894075514, 0.000001687578375, -0.000000935074337, 0.000008785281674, 0.000013870317517, -0.000007303871697, 0.000008796139724, 0.000009261617237, -0.000005024619102, -0.000000003745941, 0.030441532805909, -0.000000005287215, 0.000000000142817, 0.000000000104537, -0.000000000699593, -0.000001228578432, -0.000001228578221, 0.000000000000594, 0.008494209703819, -0.008800984521068, -0.011029750759874,
//         -0.000000806769194, 0.000000931409751, -0.000001169252264, -0.000011158181564, 0.000010349036958, -0.000007038451872, -0.000015536093832, 0.000011971510732, 0.000000179564865, 0.000000000021500, -0.000000005287215, 0.030441538983503, -0.000000000085975, 0.000000000439474, 0.000000002833766, 0.000000000000626, -0.000000000000133, -0.000001737472481, 0.014626737886497, 0.007995100880747, 0.004730704928452,
//         -0.000120046198634, 0.000336952083771, -0.000058587206026, -0.000215967315260, 0.000568829060309, -0.000139972384932, -0.000007025439940, 0.000016707575841, -0.000018896196843, 0.000000000322249, 0.000000000142817, -0.000000000085975, 0.000098376596855, -0.000000313006356, -0.000000107977403, -0.000000000003941, 0.000000000002772, 0.000000000001476, 0.000000034337032, -0.000000332826250, 0.000001079535735,
//         -0.000045241445053, -0.000043005745224, 0.000400285860733, -0.000031559916775, -0.000242431336550, 0.000792242228653, 0.000025806098460, -0.000071719343587, 0.000073926510897, 0.000000000737239, 0.000000000104537, 0.000000000439474, -0.000000313006356, 0.000098822606225, 0.000000056381110, -0.000000000002968, 0.000000000002476, 0.000000000000277, -0.000000302832302, -0.000001195886196, 0.000002422648320,
//         -0.000322677314011, -0.000121880243164, -0.000097587873057, -0.000483364347422, -0.000151921146252, -0.000330439860898, 0.000014597868320, 0.000015966010613, -0.000101849322803, 0.000000000949599, -0.000000000699593, 0.000000002833766, -0.000000107977403, 0.000000056381110, 0.000098216860229, 0.000000000004234, 0.000000000000271, -0.000000000002588, -0.000001768236402, -0.000003157960163, 0.000003040233061,
//         -0.000000045981461, -0.000000033007171, -0.000000014266519, -0.000000157281565, -0.000000125463353, -0.000000050503335, -0.000000026761033, -0.000000028262743, -0.000000011312880, -0.000001228578887, -0.000001228578432, 0.000000000000626, -0.000000000003941, -0.000000000002968, 0.000000000004234, 0.000099549929645, -0.000000000000006, -0.000000000000011, -0.000000000124938, 0.000000001712764, -0.000000003537412,
//         0.000000034192320, 0.000000023201864, 0.000000012073431, 0.000000106118441, 0.000000077030568, 0.000000040290120, 0.000000017272035, 0.000000016236318, 0.000000009450372, 0.000001228578863, -0.000001228578221, -0.000000000000133, 0.000000000002772, 0.000000000002476, 0.000000000000271, -0.000000000000006, 0.000099549929640, 0.000000000000007, -0.000000000290890, -0.000000000666870, 0.000000002646213,
//         0.000000038456085, 0.000000040045386, 0.000000030720865, 0.000000130495373, 0.000000127340179, 0.000000104612937, 0.000000026867073, 0.000000019389402, 0.000000017168715, 0.000000000000691, 0.000000000000594, -0.000001737472481, 0.000000000001476, 0.000000000000277, -0.000000000002588, -0.000000000000011, 0.000000000000007, 0.000099549929643, -0.000000000620875, -0.000000000857192, 0.000000001332827,
//         -0.000141454304177, -0.000775985818493, 0.000099929407104, 0.001822953833627, -0.009017527996872, -0.001513178549321, 0.006844186599915, -0.010709623353347, -0.005691029695700, -0.001223907914016, 0.008494209703819, 0.014626737886497, 0.000000034337032, -0.000000302832302, -0.000001768236402, -0.000000000124938, -0.000000000290890, -0.000000000620875, -0.012935328594553, -0.018564875955354, 0.005434178063403,
//         -0.002368543433779, -0.006928792786635, 0.003587826402238, -0.015266460202415, -0.063764093122778, 0.022237506926796, -0.002899679395329, -0.054706812271069, 0.003318207463686, -0.000241346768347, -0.008800984521066, 0.007995100880745, -0.000000332826250, -0.000001195886196, -0.000003157960162, 0.000000001712764, -0.000000000666870, -0.000000000857192, -0.018564875955355, 0.083442231597588, -0.084492703881115,
//         0.006519051327127, 0.017533313529459, -0.010010171244053, 0.051636200950246, 0.154926605127197, -0.069165443814694, 0.032680597165730, 0.122757381666517, -0.028559021484413, 0.000078010664043, -0.011029750759869, 0.004730704928456, 0.000001079535735, 0.000002422648320, 0.000003040233061, -0.000000003537412, 0.000000002646213, 0.000000001332827, 0.005434178063398, -0.084492703881065, 0.150252485814101,
//     };

//     TEST_ASSERT_DOUBLE_ARRAY_WITHIN(1e-6, exp_x, ukf.X, 22);
//     TEST_ASSERT_DOUBLE_ARRAY_WITHIN(1e-6, exp_P, ukf.P, 21*21);
// }